<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM de Vendas (Produção)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        :root {
            --primary: #2c3e50; --secondary: #34495e; --accent: #e74c3c; --light: #ecf0f1;
            --success: #2ecc71; --warning: #f39c12; --danger: #c0392b; --text: #333; --text-light: #fff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f7fa; color: var(--text); line-height: 1.6; }
        .container { display: grid; grid-template-columns: 250px 1fr; min-height: 100vh; }
        .sidebar { background: var(--primary); color: var(--text-light); padding: 20px 0; position: fixed; width: 250px; height: 100vh; overflow-y: auto; transition: transform 0.3s ease-in-out; }
        .logo { text-align: center; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .logo h1 { font-size: 24px; font-weight: 600; }
        .menu { list-style: none; padding: 0 15px; }
        .menu-item { margin-bottom: 5px; }
        .menu-link { display: flex; align-items: center; padding: 12px 15px; color: var(--text-light); text-decoration: none; border-radius: 5px; transition: all 0.3s ease; }
        .menu-link:hover, .menu-link.active { background: var(--secondary); }
        .menu-link i { margin-right: 10px; font-size: 18px; }
        .main { grid-column: 2; padding: 20px; transition: margin-left 0.3s ease-in-out; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #ddd; }
        .page-title { font-size: 24px; font-weight: 600; }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; transition: all 0.3s ease; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); padding: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .filters { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-label { display: block; margin-bottom: 5px; font-weight: 500; }
        .filter-select, .filter-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .data-table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        .data-table th { background: var(--primary); color: white; font-weight: 500; cursor: pointer; }
        .data-table th .sort-icon { margin-left: 5px; opacity: 0.5; }
        .data-table th.sorted .sort-icon { opacity: 1; }
        .data-table tr:hover { background: #f9f9f9; }
        .data-table .actions-cell { display: flex; gap: 5px; }
        .comment-cell { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .heatmap-cell { display: flex; align-items: center; gap: 10px; }
        .heatmap-bar-container { width: 100px; height: 10px; background-color: #eee; border-radius: 5px; }
        .heatmap-bar { height: 100%; border-radius: 5px; }
        .heatmap-value { font-weight: bold; }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: 500; color: white; text-transform: capitalize; }
        .status-aberto { background: #f39c12; }
        .status-cotação { background: #3498db; }
        .status-negociação { background: #8e44ad; }
        .status-fechado { background: #2ecc71; }
        .status-perdido { background: #e74c3c; }
        .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 10px; width: 90%; max-width: 800px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .modal-title { font-size: 20px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .form-textarea { min-height: 80px; resize: vertical; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom: 3px solid var(--primary); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .kpi-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; }
        .kpi-value { font-size: 22px; font-weight: 700; margin: 10px 0; color: var(--primary); }
        .kpi-label { font-size: 14px; color: #777; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 5px; background: var(--success); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: translateX(120%); transition: transform 0.3s ease-in-out; z-index: 1100; }
        .notification.show { transform: translateX(0); }
        .mobile-menu-btn { display: none; background: var(--primary); color: white; border: none; border-radius: 5px; padding: 10px 15px; margin-bottom: 15px; cursor: pointer; position: fixed; top: 15px; left: 15px; z-index: 999; }
        
        /* Sales Funnel Styles */
        .funnel-container { display: flex; flex-direction: column; gap: 20px; }
        .funnel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .funnel-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .funnel-visualization { display: flex; flex-direction: column; gap: 15px; }
        .funnel-stage { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .funnel-stage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .funnel-stage-title { font-weight: 600; font-size: 16px; }
        .funnel-stage-count { background: var(--primary); color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px; }
        .funnel-items { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .funnel-item { background: #f8f9fa; border-radius: 6px; padding: 12px; border-left: 4px solid; }
        .funnel-item-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .funnel-item-title { font-weight: 600; }
        .funnel-item-details { font-size: 13px; color: #666; }
        .funnel-item-progress { height: 6px; background: #e9ecef; border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .funnel-item-progress-bar { height: 100%; border-radius: 3px; }
        
        /* New styles for urgency highlighting */
        .urgency-high { background-color: #ffebee; }
        .urgency-medium { background-color: #fff8e1; }
        .urgency-low { background-color: #e8f5e9; }
        .urgency-icon { margin-left: 5px; font-size: 14px; }
        .closing-soon { border-left: 4px solid #e74c3c !important; }
        .closing-medium { border-left: 4px solid #f39c12 !important; }
        .closing-far { border-left: 4px solid #2ecc71 !important; }
        
        /* Sales process guidance styles */
        .process-guidance { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .process-stage { margin-bottom: 15px; }
        .process-stage-title { font-weight: 600; margin-bottom: 8px; color: var(--primary); }
        .next-steps { margin-left: 20px; }
        .next-step { display: flex; align-items: center; margin-bottom: 5px; }
        .next-step input[type="checkbox"] { margin-right: 10px; }
        .best-practices { margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border-left: 3px solid var(--primary); }

.data-table tr {
    transition: background-color 0.2s ease;
}

.data-table tr:hover {
    background-color: #f5f5f5 !important;
}

.data-table tr:hover td {
    background-color: transparent !important;
}
        
.funnel-stage {
    margin-bottom: 20px;
    border: 1px solid #eee;
    border-radius: 8px;
    overflow: hidden;
}

.funnel-stage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #eee;
}

.funnel-stage-title {
    font-weight: 600;
    color: var(--primary);
}

.funnel-stage-count {
    background-color: var(--primary);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
}

.funnel-stage-items {
    padding: 10px;
}

.funnel-item {
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 6px;
    background-color: white;
    border: 1px solid #eee;
    cursor: pointer;
    transition: all 0.2s ease;
}

.funnel-item:hover {
    background-color: #f8f9fa;
    border-color: #ddd;
    transform: translateX(5px);
}

.funnel-item-content {
    display: flex;
    flex-direction: column;
}

.funnel-item-title {
    font-weight: 600;
    margin-bottom: 5px;
}

.funnel-item-details {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #666;
}
        
        @media (max-width: 992px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { transform: translateX(-100%); z-index: 1000; }
            .sidebar.active { transform: translateX(0); }
            .main { grid-column: 1; margin-left: 0; padding-top: 70px; }
            .mobile-menu-btn { display: block; }
            .charts { grid-template-columns: 1fr; }
            .funnel-items { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <h1>CRM de Vendas</h1>
            </div>
            <ul class="menu">
                <li class="menu-item"><a href="#" class="menu-link active" data-tab="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="menu-item"><a href="#" class="menu-link" data-tab="sales-funnel"><i class="fas fa-chart-line"></i> Funil de Vendas</a></li>
                <li class="menu-item"><a href="#" class="menu-link" data-tab="kpis"><i class="fas fa-tachometer-alt"></i> KPIs</a></li>
                <li class="menu-item"><a href="#" class="menu-link" data-tab="management"><i class="fas fa-tasks"></i> Gerenciamento</a></li>
                <li class="menu-item"><a href="#" class="menu-link" data-tab="reports"><i class="fas fa-chart-pie"></i> Relatórios</a></li>
                <li class="menu-item"><a href="#" class="menu-link" data-tab="settings"><i class="fas fa-cog"></i> Configurações</a></li>
            </ul>
        </div>

        <div class="main" id="main-content">
            <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
            <div class="header">
                <h2 class="page-title">Dashboard de Vendas</h2>
                <div id="dashboard-actions" class="action-buttons">
                    <button class="btn btn-primary" id="addOfferBtn"><i class="fas fa-plus"></i> Nova Proposta</button>
                </div>
            </div>
            
            <div class="tab-content active" id="dashboard">
                <div class="dashboard-cards">
                    <div class="card"><h3 class="card-header">Total de Propostas</h3><div class="card-body"><h4 id="total-offers" class="kpi-value">0</h4></div></div>
                    <div class="card"><h3 class="card-header">Valor Total</h3><div class="card-body"><h4 id="total-value" class="kpi-value">R$0</h4></div></div>
                    <div class="card"><h3 class="card-header">Taxa de Conversão</h3><div class="card-body"><h4 id="conversion-rate" class="kpi-value">0%</h4></div></div>
                </div>
                <div class="filters">
                    <div class="filter-group"><label class="filter-label">Vendedor</label><select class="filter-select" id="salesPersonFilter"></select></div>
                    <div class="filter-group"><label class="filter-label">Status</label><select class="filter-select" id="statusFilter"></select></div>
                    <div class="filter-group"><label class="filter-label">Heatmap</label><select class="filter-select" id="heatmapFilter"></select></div>
                    <div class="filter-group"><label class="filter-label">Mercado</label><select class="filter-select" id="marketFilter"></select></div>
                    <div class="filter-group"><label class="filter-label">Urgência</label><select class="filter-select" id="urgencyFilter">
                        <option value="">Todas</option>
                        <option value="high">Alta Urgência</option>
                        <option value="medium">Média Urgência</option>
                        <option value="low">Baixa Urgência</option>
                    </select></div>
                    <div class="filter-group" style="align-self: flex-end;">
                        <button class="btn btn-info" id="resetFiltersBtn"><i class="fas fa-undo"></i> Limpar Filtros</button>
                    </div>
                </div>
<div class="data-table-container">
    <table class="data-table" id="offersTable">
        <thead>
            <tr>
                <th>Ações</th>
                <th>Urgência</th>
                <th data-sort="offerNumber">Proposta # <i class="fas fa-sort sort-icon"></i></th>
                <th data-sort="salesPerson">Vendedor <i class="fas fa-sort sort-icon"></i></th>
                <th data-sort="customer">Cliente <i class="fas fa-sort sort-icon"></i></th>
                <th data-sort="value">Valor <i class="fas fa-sort sort-icon"></i></th>
                <th data-sort="offerDate">Data da Proposta <i class="fas fa-sort sort-icon"></i></th>
                <th data-sort="heatmap">Heatmap <i class="fas fa-sort sort-icon"></i></th>
                <th data-sort="status">Status <i class="fas fa-sort sort-icon"></i></th>
                <th>Comentários</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
                
                <div class="process-guidance">
                    <h3>Orientação do Processo de Vendas</h3>
                    <div class="process-stage">
                        <div class="process-stage-title">Prospecção</div>
                        <div class="next-steps">
                            <label class="next-step"><input type="checkbox"> Pesquisar informações do cliente</label>
                            <label class="next-step"><input type="checkbox"> Identificar tomador de decisão</label>
                            <label class="next-step"><input type="checkbox"> Preparar abordagem inicial</label>
                        </div>
                        <div class="best-practices">
                            <strong>Melhores Práticas:</strong> Foque em entender as necessidades do cliente antes de apresentar soluções.
                        </div>
                    </div>
                    <div class="process-stage">
                        <div class="process-stage-title">Qualificação</div>
                        <div class="next-steps">
                            <label class="next-step"><input type="checkbox"> Agendar reunião de qualificação</label>
                            <label class="next-step"><input type="checkbox"> Identificar orçamento e timeframe</label>
                            <label class="next-step"><input type="checkbox"> Validar necessidade real</label>
                        </div>
                        <div class="best-practices">
                            <strong>Melhores Práticas:</strong> Use perguntas abertas para descobrir dores e objetivos.
                        </div>
                    </div>
                    <div class="process-stage">
                        <div class="process-stage-title">Proposta</div>
                        <div class="next-steps">
                            <label class="next-step"><input type="checkbox"> Personalizar proposta</label>
                            <label class="next-step"><input type="checkbox"> Incluir casos de sucesso relevantes</label>
                            <label class="next-step"><input type="checkbox"> Agendar apresentação</label>
                        </div>
                        <div class="best-practices">
                            <strong>Melhores Práticas:</strong> Destaque o ROI e benefícios específicos para o cliente.
                        </div>
                    </div>
                    <div class="process-stage">
                        <div class="process-stage-title">Negociação</div>
                        <div class="next-steps">
                            <label class="next-step"><input type="checkbox"> Preparar contraproposta</label>
                            <label class="next-step"><input type="checkbox"> Identificar objeções</label>
                            <label class="next-step"><input type="checkbox"> Oferecer prova social</label>
                        </div>
                        <div class="best-practices">
                            <strong>Melhores Práticas:</strong> Mantenha foco no valor, não apenas no preço.
                        </div>
                    </div>
                    <div class="process-stage">
                        <div class="process-stage-title">Fechado</div>
                        <div class="next-steps">
                            <label class="next-step"><input type="checkbox"> Enviar documentação final</label>
                            <label class="next-step"><input type="checkbox"> Agendar onboarding</label>
                            <label class="next-step"><input type="checkbox"> Solicitar referência</label>
                        </div>
                        <div class="best-practices">
                            <strong>Melhores Práticas:</strong> Celebre a vitória e planeje a expansão da conta.
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="sales-funnel">
                <div class="funnel-container">
                    <div class="funnel-header">
                        <h2>Funil de Vendas Avançado</h2>
                        <div class="action-buttons">
                            <button class="btn btn-info" id="exportFunnelPdf"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                            <button class="btn btn-success" id="exportFunnelXlsx"><i class="fas fa-file-excel"></i> Exportar XLSX</button>
                        </div>
                    </div>
                    
                    <div class="funnel-filters">
                        <div class="filter-group">
                            <label class="filter-label">Vendedor</label>
                            <select class="filter-select" id="funnelSalesPersonFilter">
                                <option value="">Todos os Vendedores</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Cliente</label>
                            <select class="filter-select" id="funnelCustomerFilter">
                                <option value="">Todos os Clientes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Heatmap</label>
                            <select class="filter-select" id="funnelHeatmapFilter">
                                <option value="">Todos</option>
                                <option value="1-3">Baixo (1-3)</option>
                                <option value="4-7">Médio (4-7)</option>
                                <option value="8-10">Alto (8-10)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Data de Fechamento</label>
                            <input type="date" class="filter-input" id="funnelClosingDateFilter">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Urgência</label>
                            <select class="filter-select" id="funnelUrgencyFilter">
                                <option value="">Todas</option>
                                <option value="high">Alta Urgência</option>
                                <option value="medium">Média Urgência</option>
                                <option value="low">Baixa Urgência</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3 class="card-header">Visão Geral do Funil</h3>
                        <canvas id="funnelOverviewChart"></canvas>
                    </div>
                    
                    <div class="funnel-visualization" id="funnelStagesContainer">
                        </div>
                </div>
            </div>


<div class="tab-content" id="funnel">
    <div class="header">
        <h2 class="page-title">Funil de Vendas</h2>
    </div>
    
    <div id="no-funnel-data" class="card" style="text-align: center; padding: 40px; display: none;">
        <div style="font-size: 48px; color: #ccc; margin-bottom: 20px;">
            <i class="fas fa-filter"></i>
        </div>
        <h3>Dados insuficientes para análise</h3>
        <p>Adicione propostas para visualizar o funil de vendas</p>
        <button class="btn btn-primary" id="go-to-import-funnel" style="margin-top: 20px;">
            <i class="fas fa-plus"></i> Nova Proposta
        </button>
    </div>
    
    <div id="funnel-content">
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Vendedor</label>
                <select class="filter-select" id="funnel-users">
                    <option value="all">Todos os Vendedores</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Mercado</label>
                <select class="filter-select" id="funnel-markets">
                    <option value="all">Todos os Mercados</option>
                </select>
            </div>
            <div class="filter-group" style="align-self: flex-end;">
                <button class="btn btn-primary" id="apply-funnel-filters">Aplicar Filtros</button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3>Análise do Funil de Vendas</h3>
            </div>
            <div class="card-body">
                <div class="funnel-container" id="funnel-visual">
                    
                    </div>
                
                <canvas id="funnelChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>




            <div class="tab-content" id="sales-funnel"><div class="chart-container"><h3 class="card-header">Funil de Vendas por Etapa</h3><canvas id="funnelDetailChart"></canvas></div></div>
            <div class="tab-content" id="kpis"><div class="card"><div class="card-header">Análise de KPIs<button class="btn btn-primary" id="exportKpisPdf"><i class="fas fa-file-pdf"></i> Exportar para PDF</button></div><div id="kpi-details-grid" class="kpi-grid"></div></div></div>
            <div class="tab-content" id="management">
                <div class="tabs"><div class="tab active" data-subtab="sales-team">Equipe de Vendas</div><div class="tab" data-subtab="customers">Clientes</div></div>
                <div class="tab-content active" id="sales-team"><button class="btn btn-primary" id="addSalesPersonBtn"><i class="fas fa-plus"></i> Adicionar Vendedor</button><div class="data-table-container"><table class="data-table" id="salesTeamTable"><thead><tr><th>Nome</th><th>Email</th><th>Ações</th></tr></thead><tbody></tbody></table></div></div>
                <div class="tab-content" id="customers"><button class="btn btn-primary" id="addCustomerBtn"><i class="fas fa-plus"></i> Adicionar Cliente</button><div class="data-table-container"><table class="data-table" id="customersTable"><thead><tr><th>Nome</th><th>Setor</th><th>Contato</th><th>Telefone</th><th>Email</th><th>Ações</th></tr></thead><tbody></tbody></table></div></div>
            </div>
            <div class="tab-content" id="reports"><div class="card"><div class="card-header">Relatórios de Vendas<button class="btn btn-primary" id="exportReportsPdf"><i class="fas fa-file-pdf"></i> Exportar para PDF</button></div><div class="charts"><div class="chart-container"><h3 class="card-header">Vendas por Mercado</h3><canvas id="marketChart"></canvas></div><div class="chart-container"><h3 class="card-header">Vendas por Vendedor</h3><canvas id="salesPersonChart"></canvas></div></div><div class="kpi-grid" id="kpi-grid-reports"></div></div></div>
            
            <div class="tab-content" id="settings">
                 <div class="card">
                    <h3 class="card-header">Gerenciamento do Banco de Dados</h3>
                    <div class="action-buttons">
                        <button class="btn btn-success" id="importXlsxBtn"><i class="fas fa-file-excel"></i> Importar (XLSX)</button>
                        <button class="btn btn-primary" id="exportXlsxBtn"><i class="fas fa-file-excel"></i> Exportar (XLSX)</button>
                        <button class="btn btn-warning" id="exportJsonBtn"><i class="fas fa-file-export"></i> Exportar (JSON)</button>
                        <button class="btn btn-danger" id="clearDbBtn"><i class="fas fa-trash-alt"></i> Limpar Todos os Dados</button>
                    </div>
                    <small style="display:block; margin-top:10px;">A importação substituirá todos os dados existentes. Exporte uma cópia de segurança primeiro.</small>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="offerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar/Editar Proposta</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="offerForm">
                <input type="hidden" id="editOfferId">
                <div class="form-group">
                    <label class="form-label">Vendedor</label>
                    <select class="form-select" id="salesPersonSelect" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Cliente</label>
                    <select class="form-select" id="customerSelect" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Mercado</label>
                    <select class="form-select" id="marketSelect" required></select>
                </div>

                <div class="form-group">
                    <label class="form-label">PN Itens (um por linha)</label>
                    <textarea class="form-textarea" id="pnitemsselect" placeholder="PN-001&#10;PN-002&#10;PN-003"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Quantidade (um por linha)</label>
                    <textarea class="form-textarea" id="quantidadeselect" placeholder="10&#10;5&#10;20"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Preço Unitário (um por linha)</label>
                    <textarea class="form-textarea" id="precoselect" placeholder="150.50&#10;300.00&#10;75.25"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Valor da Proposta</label>
                    <input type="number" class="form-input" id="offerValueInput" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Data da Proposta</label>
                    <input type="date" class="form-input" id="offerDateInput" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Data de Lembrete</label>
                    <input type="date" class="form-input" id="reminderDateInput">
                </div>

                <div class="form-group">
                    <label class="form-label">Data Estimada de Fechamento</label>
                    <input type="date" class="form-input" id="closingDateInput" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Heatmap (1-10)</label>
                    <input type="number" class="form-input" id="heatmapInput" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="statusSelect" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Probabilidade de Fechamento (%)</label>
                    <input type="number" class="form-input" id="probabilityInput" min="0" max="100" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Número de Visitas</label>
                    <input type="number" class="form-input" id="visitsInput" min="0" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Número de Revisões da Proposta</label>
                    <input type="number" class="form-input" id="revisionsInput" min="0" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Comentários</label>
                    <textarea class="form-textarea" id="commentsInput"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Salvar Proposta</button>
            </form>
        </div>
    </div>

    <div class="modal" id="salesPersonModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar/Editar Vendedor</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="salesPersonForm">
                <input type="hidden" id="editSalesPersonId">
                <div class="form-group">
                    <label class="form-label">Nome</label>
                    <input type="text" class="form-input" id="salesPersonName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="salesPersonEmail" required>
                </div>
                <button type="submit" class="btn btn-primary">Salvar Vendedor</button>
            </form>
        </div>
    </div>
    
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar/Editar Cliente</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="customerForm">
                <input type="hidden" id="editCustomerId">
                <div class="form-group">
                    <label class="form-label">Nome da Empresa</label>
                    <input type="text" class="form-input" id="customerName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Setor</label>
                    <input type="text" class="form-input" id="customerIndustry" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Nome do Contato</label>
                    <input type="text" class="form-input" id="customerContactName">
                </div>
                <div class="form-group">
                    <label class="form-label">Telefone</label>
                    <input type="tel" class="form-input" id="customerContactPhone">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="customerContactEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">Departamento</label>
                    <input type="text" class="form-input" id="customerContactDepartment">
                </div>
                <button type="submit" class="btn btn-primary">Salvar Cliente</button>
            </form>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyAfL4-_B9_sV1WKwZqHhsWxH9xPfysEHVk",
        authDomain: "crm-mge.firebaseapp.com",
        projectId: "crm-mge",
        storageBucket: "crm-mge.appspot.com",
        messagingSenderId: "520336828101",
        appId: "1:520336828101:web:6740003050125e424132ac",
        measurementId: "G-186RYW248T"
    };

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();

    document.addEventListener('DOMContentLoaded', function() {
        // --- DATA MANAGEMENT & STATE ---
        let db = { offers: [], salesTeam: [], customers: [] };
        let sortState = { column: 'offerNumber', direction: 'asc' };
        
        const MARKETS = ['Conforto', 'Industrial', 'Precisão', 'Telecom','Hospitalar', 'Data Center', 'Produtos Customizados'];
        const STATUSES = {
            'prospecção': 'Prospecção', 
            'qualificação': 'Qualificação', 
            'proposta': 'Proposta', 
            'negociação': 'Negociação', 
            'fechado': 'Fechado', 
            'perdido': 'Perdido'
        };
        const HEATMAP_RANGES = { '': 'Todos', '1-3': 'Baixo (1-3)', '4-7': 'Médio (4-7)', '8-10': 'Alto (8-10)' };
        
        // Colors for each stage in the funnel
        const STAGE_COLORS = {
            'prospecção': '#3498db',
            'qualificação': '#9b59b6',
            'proposta': '#f1c40f',
            'negociação': '#e67e22',
            'fechado': '#2ecc71',
            'perdido': '#e74c3c'
        };

        // --- FUNÇÕES DE BANCO DE DADOS (FIRESTORE) ---
        async function loadDb() {
            showNotification("Carregando dados da nuvem...");
            try {
                const [salesTeamSnap, customersSnap, offersSnap] = await Promise.all([
                    firestore.collection('salesTeam').orderBy('name').get(),
                    firestore.collection('customers').orderBy('name').get(),
                    firestore.collection('offers').get()
                ]);

                db.salesTeam = salesTeamSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                db.customers = customersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                db.offers = offersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderAll();
                showNotification("Dados carregados com sucesso!", false);
            } catch (error) {
                console.error("Erro ao carregar dados do Firestore: ", error);
                showNotification("Erro ao carregar dados. Verifique o console.", true);
            }
        }

        const formatCurrency = (val) => `R$${(val || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        const generateOfferNumber = () => `PROP-${new Date().getFullYear()}-${String(db.offers.length + 1).padStart(3, '0')}`;
        const getById = (arr, id) => arr.find(item => item.id === id);
        
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = isError ? 'var(--danger)' : 'var(--success)';
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        function renderAll() {
            populateAllDropdowns();
            renderOffersTable();
            renderSalesTeamTable();
            renderCustomersTable();
            updateAllCharts();
            updateKPIs('kpi-grid-reports');
            renderKpiPage();
            renderSalesFunnel();
            populateFunnelFilters();
        }
        
        function populateSelect(elementId, data, options = {}) {
            const { key = 'id', value = 'name', placeholder = 'Todos' } = options;
            const select = document.getElementById(elementId);
            select.innerHTML = `<option value="">${placeholder}</option>`;
            data.forEach(item => {
                select.innerHTML += `<option value="${item[key]}">${item[value]}</option>`;
            });
        }

        function populateFunnelFilters() {
            populateSelect('funnel-users', db.salesTeam, { placeholder: 'Todos os Vendedores', value: 'name' });
            populateStaticSelect('funnel-markets', MARKETS, 'Todos os Mercados');
        }

        // Function to render the sales funnel
        function renderSalesFunnelVisualization() {
            const funnelContent = document.getElementById('funnel-content');
            const noFunnelData = document.getElementById('no-funnel-data');
            
            if (db.offers.length === 0) {
                funnelContent.style.display = 'none';
                noFunnelData.style.display = 'block';
                return;
            }
            
            funnelContent.style.display = 'block';
            noFunnelData.style.display = 'none';
            
            const userFilter = document.getElementById('funnel-users').value;
            const marketFilter = document.getElementById('funnel-markets').value;
            
            let filteredOffers = db.offers.filter(offer => {
                const userMatch = userFilter === 'all' || offer.salesPersonId === userFilter;
                const marketMatch = marketFilter === 'all' || offer.market === marketFilter;
                return userMatch && marketMatch;
            });
            
            const statusCounts = {};
            Object.keys(STATUSES).forEach(status => {
                statusCounts[status] = filteredOffers.filter(o => o.status === status).length;
            });
            
            const funnelVisual = document.getElementById('funnel-visual');
            funnelVisual.innerHTML = '';
            
            Object.entries(STATUSES).forEach(([statusKey, statusLabel]) => {
                const count = statusCounts[statusKey];
                const percentage = filteredOffers.length > 0 ? (count / filteredOffers.length * 100).toFixed(1) : 0;
                
                const stageElement = document.createElement('div');
                stageElement.className = 'funnel-stage';
                stageElement.innerHTML = `
                    <div class="funnel-stage-header">
                        <span class="funnel-stage-title">${statusLabel}</span>
                        <span class="funnel-stage-count">${count} (${percentage}%)</span>
                    </div>
                    <div class="funnel-stage-items">
                        ${filteredOffers.filter(o => o.status === statusKey).map(offer => {
                            const salesPerson = getById(db.salesTeam, offer.salesPersonId)?.name || 'N/A';
                            const customer = getById(db.customers, offer.customerId)?.name || 'N/A';
                            
                            return `
                                <div class="funnel-item" onclick="handleEditOffer('${offer.id}')">
                                    <div class="funnel-item-content">
                                        <div class="funnel-item-title">${customer}</div>
                                        <div class="funnel-item-details">
                                            <span>${salesPerson}</span>
                                            <span>${formatCurrency(offer.value)}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                funnelVisual.appendChild(stageElement);
            });
            
            updateFunnelChart(Object.values(STATUSES), Object.values(statusCounts));
        }

        function updateFunnelChart(labels, data) {
            const ctx = document.getElementById('funnelChart').getContext('2d');
            
            if (charts.funnelChart) {
                charts.funnelChart.destroy();
            }
            
            charts.funnelChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Número de Oportunidades',
                        data: data,
                        backgroundColor: Object.keys(STATUSES).map(status => STAGE_COLORS[status] || '#3498db'),
                        borderColor: Object.keys(STATUSES).map(status => STAGE_COLORS[status] || '#3498db'),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false }, title: { display: true, text: 'Oportunidades por Estágio' } },
                    scales: { x: { beginAtZero: true } }
                }
            });
        }
        
        function populateStaticSelect(elementId, data, placeholder) {
            const select = document.getElementById(elementId);
            let optionsHtml = placeholder ? `<option value="">${placeholder}</option>` : '';
            if (Array.isArray(data)) {
                data.forEach(item => optionsHtml += `<option value="${item}">${item}</option>`);
            } else {
                Object.entries(data).forEach(([key, value]) => optionsHtml += `<option value="${key}">${value}</option>`);
            }
            select.innerHTML = optionsHtml;
        }

        function populateAllDropdowns() {
            populateSelect('salesPersonFilter', db.salesTeam, { placeholder: 'Todos os Vendedores' });
            populateStaticSelect('statusFilter', {...{'': 'Todos os Status'}, ...STATUSES});
            populateStaticSelect('heatmapFilter', HEATMAP_RANGES);
            populateStaticSelect('marketFilter', {...{'': 'Todos os Mercados'}, ...MARKETS.reduce((acc, m) => ({...acc, [m]: m}), {})});
            
            populateSelect('salesPersonSelect', db.salesTeam, { placeholder: 'Selecione um Vendedor' });
            populateSelect('customerSelect', db.customers, { placeholder: 'Selecione um Cliente' });
            
            populateStaticSelect('marketSelect', MARKETS, 'Selecione um Mercado');
            populateStaticSelect('statusSelect', STATUSES, 'Selecione um Status');
            
            populateSelect('funnelSalesPersonFilter', db.salesTeam, { placeholder: 'Todos os Vendedores' });
            populateSelect('funnelCustomerFilter', db.customers, { placeholder: 'Todos os Clientes' });
        }

        function calculateUrgency(offer) {
            const today = new Date();
            const closingDate = new Date(offer.closingDate + 'T00:00:00');
            const daysUntilClosing = Math.ceil((closingDate - today) / (1000 * 60 * 60 * 24));
            
            let score = 0;
            score += (offer.heatmap / 10) * 40;
            if (daysUntilClosing <= 7) score += 30;
            else if (daysUntilClosing <= 14) score += 20;
            else if (daysUntilClosing <= 30) score += 10;
            
            const maxValue = Math.max(...db.offers.map(o => o.value), 100000);
            score += (offer.value / maxValue) * 20;
            score += (offer.probability / 100) * 10;
            
            return { score: Math.min(100, Math.round(score)), daysUntilClosing: daysUntilClosing };
        }

        function getUrgencyInfo(urgencyScore, daysUntilClosing) {
            if (urgencyScore >= 70 || daysUntilClosing <= 3) {
                return { level: 'high', label: 'Alta', icon: 'fas fa-exclamation-circle', color: '#e74c3c', rowClass: 'urgency-high' };
            } else if (urgencyScore >= 40 || daysUntilClosing <= 7) {
                return { level: 'medium', label: 'Média', icon: 'fas fa-exclamation-triangle', color: '#f39c12', rowClass: 'urgency-medium' };
            } else {
                return { level: 'low', label: 'Baixa', icon: 'fas fa-info-circle', color: '#2ecc71', rowClass: 'urgency-low' };
            }
        }

        function renderOffersTable() {
            const tableBody = document.querySelector('#offersTable tbody');
            tableBody.innerHTML = '';
            
            const filters = {
                salesPerson: document.getElementById('salesPersonFilter').value,
                status: document.getElementById('statusFilter').value,
                heatmap: document.getElementById('heatmapFilter').value,
                market: document.getElementById('marketFilter').value,
                urgency: document.getElementById('urgencyFilter').value,
            };

            let filteredOffers = db.offers.filter(offer => {
                const heatmapMatch = !filters.heatmap || 
                    (filters.heatmap === '1-3' && offer.heatmap <= 3) ||
                    (filters.heatmap === '4-7' && offer.heatmap >= 4 && offer.heatmap <= 7) ||
                    (filters.heatmap === '8-10' && offer.heatmap >= 8);
                
                const urgencyInfo = calculateUrgency(offer);
                const urgencyLevel = getUrgencyInfo(urgencyInfo.score, urgencyInfo.daysUntilClosing).level;
                const urgencyMatch = !filters.urgency || urgencyLevel === filters.urgency;
                
                return (!filters.salesPerson || offer.salesPersonId == filters.salesPerson) &&
                       (!filters.status || offer.status === filters.status) &&
                       (!filters.market || offer.market === filters.market) &&
                       heatmapMatch &&
                       urgencyMatch;
            });

            filteredOffers.sort((a, b) => {
                let valA, valB;
                if (sortState.column === 'salesPerson') {
                    valA = getById(db.salesTeam, a.salesPersonId)?.name || '';
                    valB = getById(db.salesTeam, b.salesPersonId)?.name || '';
                } else if (sortState.column === 'customer') {
                    valA = getById(db.customers, a.customerId)?.name || '';
                    valB = getById(db.customers, b.customerId)?.name || '';
                } else {
                    valA = a[sortState.column];
                    valB = b[sortState.column];
                }

                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });

            filteredOffers.forEach(offer => {
                const salesPerson = getById(db.salesTeam, offer.salesPersonId)?.name || 'N/A';
                const customer = getById(db.customers, offer.customerId)?.name || 'N/A';
                
                let heatmapColor;
                if (offer.heatmap >= 8) heatmapColor = '#2ecc71';
                else if (offer.heatmap >= 4) heatmapColor = '#f39c12';
                else heatmapColor = '#e74c3c';

                const urgencyInfo = calculateUrgency(offer);
                const urgency = getUrgencyInfo(urgencyInfo.score, urgencyInfo.daysUntilClosing);
                
                const row = document.createElement('tr');
                row.classList.add(urgency.rowClass);
                
                row.style.cursor = 'pointer';
                row.onclick = (e) => {
                    if (!e.target.closest('.actions-cell')) {
                        handleEditOffer(offer.id);
                    }
                };
                
                row.innerHTML = `
                    <td class="actions-cell">
                         <button class="btn btn-info btn-sm" onclick="exportOfferToPdf(event, '${offer.id}')" title="Exportar PDF"><i class="fas fa-file-pdf"></i></button>
                         <button class="btn btn-danger btn-sm" onclick="handleDelete(event, 'offers', '${offer.id}')" title="Apagar"><i class="fas fa-trash"></i></button>
                    </td>
                    <td><i class="${urgency.icon} urgency-icon" style="color: ${urgency.color};" title="Urgência: ${urgency.label} (${urgencyInfo.score}/100)"></i> ${urgency.label}</td>
                    <td>${offer.offerNumber}</td> 
                    <td>${salesPerson}</td> 
                    <td>${customer}</td>
                    <td>${formatCurrency(offer.value)}</td>
                    <td>${offer.offerDate ? new Date(offer.offerDate + 'T00:00:00').toLocaleDateString('pt-BR') : ''}</td>
                    <td><div class="heatmap-cell"><div class="heatmap-bar-container"><div class="heatmap-bar" style="width: ${offer.heatmap * 10}%; background-color: ${heatmapColor};"></div></div><span class="heatmap-value">${offer.heatmap}</span></div></td>
                    <td><span class="status-badge status-${offer.status.replace(' ', '-')}">${STATUSES[offer.status] || offer.status}</span></td>
                    <td class="comment-cell" title="${offer.comments || ''}">${offer.comments || ''}</td>`;
                tableBody.appendChild(row);
            });
            updateDashboardCards(filteredOffers);
            updateSortIcons();
        }

        function updateSortIcons() {
            document.querySelectorAll('#offersTable th[data-sort]').forEach(th => {
                th.classList.remove('sorted');
                const icon = th.querySelector('.sort-icon');
                icon.className = 'fas fa-sort sort-icon';
            });
            const activeTh = document.querySelector(`#offersTable th[data-sort="${sortState.column}"]`);
            if (activeTh) {
                activeTh.classList.add('sorted');
                const icon = activeTh.querySelector('.sort-icon');
                icon.className = sortState.direction === 'asc' ? 'fas fa-sort-up sort-icon' : 'fas fa-sort-down sort-icon';
            }
        }

        function renderSalesTeamTable() {
            const tableBody = document.querySelector('#salesTeamTable tbody');
            tableBody.innerHTML = '';
            db.salesTeam.forEach(person => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${person.name}</td><td>${person.email}</td>
                    <td class="actions-cell">
                        <button class="btn btn-primary btn-sm" onclick="handleEditSalesPerson('${person.id}')"><i class="fas fa-edit"></i> Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="handleDelete(event, 'salesTeam', '${person.id}')"><i class="fas fa-trash"></i> Apagar</button>
                    </td>`;
                tableBody.appendChild(row);
            });
        }

        function renderCustomersTable() {
            const tableBody = document.querySelector('#customersTable tbody');
            tableBody.innerHTML = '';
            db.customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.name}</td>
                    <td>${customer.industry}</td>
                    <td>${customer.contactName || 'N/A'}</td>
                    <td>${customer.contactPhone || 'N/A'}</td>
                    <td>${customer.contactEmail || 'N/A'}</td>
                    <td class="actions-cell">
                        <button class="btn btn-primary btn-sm" onclick="handleEditCustomer('${customer.id}')"><i class="fas fa-edit"></i> Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="handleDelete(event, 'customers', '${customer.id}')"><i class="fas fa-trash"></i> Apagar</button>
                    </td>`;
                tableBody.appendChild(row);
            });
        }

        function updateDashboardCards(filteredOffers = db.offers) {
            document.getElementById('total-offers').textContent = filteredOffers.length;
            const totalValue = filteredOffers.reduce((sum, offer) => sum + offer.value, 0);
            document.getElementById('total-value').textContent = formatCurrency(totalValue);
            const closedOffers = filteredOffers.filter(offer => offer.status === 'fechado').length;
            const conversionRate = filteredOffers.length > 0 ? ((closedOffers / filteredOffers.length) * 100).toFixed(1) : 0;
            document.getElementById('conversion-rate').textContent = `${conversionRate}%`;
        }
        
        let charts = {};
        function createOrUpdateChart(chartId, type, data, options) {
            const ctx = document.getElementById(chartId).getContext('2d');
            if (charts[chartId]) { charts[chartId].destroy(); }
            charts[chartId] = new Chart(ctx, { type, data, options });
        }

        function updateAllCharts() {
            const funnelData = Object.keys(STATUSES).map(status => db.offers.filter(o => o.status === status).length);
            createOrUpdateChart('funnelDetailChart', 'bar', { labels: Object.values(STATUSES), datasets: [{ label: '# de Propostas', data: funnelData, backgroundColor: ['#3498db', '#9b59b6', '#f1c40f', '#e67e22', '#2ecc71', '#e74c3c'] }] }, { indexAxis: 'y', responsive: true });
            const marketData = MARKETS.map(market => db.offers.filter(o => o.market === market).reduce((sum, o) => sum + o.value, 0));
            createOrUpdateChart('marketChart', 'pie', { labels: MARKETS, datasets: [{ label: 'Vendas por Mercado', data: marketData, backgroundColor: ['#3498db', '#2ecc71', '#f1c40f', '#e74c3c', '#9b59b6', '#1abc9c'] }] }, { responsive: true });
            const salesPersonData = db.salesTeam.map(p => db.offers.filter(o => o.salesPersonId === p.id && o.status === 'fechado').reduce((sum, o) => sum + o.value, 0));
            createOrUpdateChart('salesPersonChart', 'bar', { labels: db.salesTeam.map(p => p.name), datasets: [{ label: 'Valor Fechado em Vendas', data: salesPersonData, backgroundColor: '#2c3e50' }] }, { responsive: true });
        }
        
        function updateKPIs(gridId) {
            const kpiGrid = document.getElementById(gridId);
            if (!kpiGrid) return; kpiGrid.innerHTML = '';
            db.salesTeam.forEach(person => {
                const personOffers = db.offers.filter(o => o.salesPersonId === person.id);
                const closedOffers = personOffers.filter(o => o.status === 'fechado').length;
                const conversionRate = personOffers.length > 0 ? ((closedOffers / personOffers.length) * 100).toFixed(1) : 0;
                const kpiCard = document.createElement('div');
                kpiCard.className = 'kpi-card';
                kpiCard.innerHTML = `<div class="kpi-label">${person.name}</div><div class="kpi-value">${conversionRate}%</div><div class="kpi-label">Taxa de Conversão (${closedOffers}/${personOffers.length})</div>`;
                kpiGrid.appendChild(kpiCard);
            });
        }

        function renderKpiPage() {
            const kpiGrid = document.getElementById('kpi-details-grid');
            if (!kpiGrid) return; kpiGrid.innerHTML = '';
            db.salesTeam.forEach(person => {
                const personOffers = db.offers.filter(o => o.salesPersonId === person.id);
                const totalValue = personOffers.reduce((sum, o) => sum + o.value, 0);
                const avgDealSize = personOffers.length > 0 ? totalValue / personOffers.length : 0;
                const closedOffers = personOffers.filter(o => o.status === 'fechado');
                const conversionRate = personOffers.length > 0 ? (closedOffers.length / personOffers.length) * 100 : 0;
                const card = document.createElement('div');
                card.className = 'kpi-card';
                card.innerHTML = `<h3 class="card-header">${person.name}</h3>
                    <p class="kpi-label">Total de Propostas</p><p class="kpi-value">${personOffers.length}</p>
                    <p class="kpi-label">Valor Total</p><p class="kpi-value">${formatCurrency(totalValue)}</p>
                    <p class="kpi-label">Tamanho Médio do Negócio</p><p class="kpi-value">${formatCurrency(avgDealSize)}</p>
                    <p class="kpi-label">Taxa de Conversão</p><p class="kpi-value">${conversionRate.toFixed(1)}%</p>`;
                kpiGrid.appendChild(card);
            });
        }
        
        function renderSalesFunnel() {
            const funnelContainer = document.getElementById('funnelStagesContainer');
            if (!funnelContainer) return;
            
            const salesPersonFilter = document.getElementById('funnelSalesPersonFilter').value;
            const customerFilter = document.getElementById('funnelCustomerFilter').value;
            const heatmapFilter = document.getElementById('funnelHeatmapFilter').value;
            const closingDateFilter = document.getElementById('funnelClosingDateFilter').value;
            const urgencyFilter = document.getElementById('funnelUrgencyFilter').value;
            
            let filteredOffers = db.offers.filter(offer => {
                const heatmapMatch = !heatmapFilter || 
                    (heatmapFilter === '1-3' && offer.heatmap <= 3) ||
                    (heatmapFilter === '4-7' && offer.heatmap >= 4 && offer.heatmap <= 7) ||
                    (heatmapFilter === '8-10' && offer.heatmap >= 8);
                const closingDateMatch = !closingDateFilter || offer.closingDate === closingDateFilter;
                const urgencyInfo = calculateUrgency(offer);
                const urgencyLevel = getUrgencyInfo(urgencyInfo.score, urgencyInfo.daysUntilClosing).level;
                const urgencyMatch = !urgencyFilter || urgencyLevel === urgencyFilter;
                
                return (!salesPersonFilter || offer.salesPersonId === salesPersonFilter) &&
                       (!customerFilter || offer.customerId === customerFilter) &&
                       heatmapMatch && closingDateMatch && urgencyMatch;
            });
            
            updateFunnelOverviewChart(filteredOffers);
            funnelContainer.innerHTML = '';
            
            Object.entries(STATUSES).forEach(([statusKey, statusLabel]) => {
                const stageOffers = filteredOffers.filter(offer => offer.status === statusKey);
                const stageElement = document.createElement('div');
                stageElement.className = 'funnel-stage';
                stageElement.innerHTML = `
                    <div class="funnel-stage-header">
                        <div class="funnel-stage-title">${statusLabel}</div>
                        <div class="funnel-stage-count">${stageOffers.length}</div>
                    </div>
                    <div class="funnel-items">
                        ${stageOffers.map(offer => renderFunnelItem(offer)).join('')}
                    </div>
                `;
                funnelContainer.appendChild(stageElement);
            });
        }
        
        function renderFunnelItem(offer) {
            const salesPerson = getById(db.salesTeam, offer.salesPersonId)?.name || 'N/A';
            const customer = getById(db.customers, offer.customerId)?.name || 'N/A';
            const expectedValue = offer.value * (offer.probability / 100);
            
            let heatmapColor;
            if (offer.heatmap >= 8) heatmapColor = '#2ecc71';
            else if (offer.heatmap >= 4) heatmapColor = '#f39c12';
            else heatmapColor = '#e74c3c';
            
            const urgencyInfo = calculateUrgency(offer);
            const urgency = getUrgencyInfo(urgencyInfo.score, urgencyInfo.daysUntilClosing);
            
            return `
                <div class="funnel-item" style="border-left-color: ${STAGE_COLORS[offer.status] || '#ccc'}">
                    <div class="funnel-item-header">
                        <div class="funnel-item-title">${customer} <i class="${urgency.icon} urgency-icon" style="color: ${urgency.color};" title="Urgência: ${urgency.label} (${urgencyInfo.score}/100)"></i></div>
                        <div>${formatCurrency(offer.value)}</div>
                    </div>
                    <div class="funnel-item-details">
                        <div>Vendedor: ${salesPerson}</div>
                        <div>Heatmap: ${offer.heatmap}/10</div>
                        <div>Probabilidade: ${offer.probability || 0}%</div>
                        <div>Visitas: ${offer.visits || 0}</div>
                        <div>Revisões: ${offer.revisions || 0}</div>
                        <div>Fechamento: ${offer.closingDate ? new Date(offer.closingDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</div>
                        <div>Urgência: ${urgency.label} (${urgencyInfo.score}/100)</div>
                    </div>
                    <div class="funnel-item-progress">
                        <div class="funnel-item-progress-bar" style="width: ${offer.probability || 0}%; background-color: ${heatmapColor};"></div>
                    </div>
                </div>
            `;
        }
        
        function updateFunnelOverviewChart(offers) {
            const stageCounts = {};
            Object.keys(STATUSES).forEach(status => {
                stageCounts[status] = offers.filter(offer => offer.status === status).length;
            });
            
            const expectedValues = {};
            Object.keys(STATUSES).forEach(status => {
                expectedValues[status] = offers
                    .filter(offer => offer.status === status)
                    .reduce((sum, offer) => sum + (offer.value * (offer.probability / 100)), 0);
            });
            
            const ctx = document.getElementById('funnelOverviewChart').getContext('2d');
            if (charts['funnelOverviewChart']) {
                charts['funnelOverviewChart'].destroy();
            }
            
            charts['funnelOverviewChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.values(STATUSES),
                    datasets: [
                        { label: 'Número de Oportunidades', data: Object.values(stageCounts), backgroundColor: Object.keys(STATUSES).map(status => STAGE_COLORS[status]), yAxisID: 'y', },
                        { label: 'Valor Esperado (R$)', data: Object.values(expectedValues), backgroundColor: '#2c3e50', type: 'line', yAxisID: 'y1', fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Número de Oportunidades' } },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Valor Esperado (R$)' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        
        window.handleEditOffer = (id) => {
            const offer = getById(db.offers, id); if (!offer) return;
            document.getElementById('editOfferId').value = offer.id;
            document.getElementById('salesPersonSelect').value = offer.salesPersonId;
            document.getElementById('customerSelect').value = offer.customerId;
            document.getElementById('marketSelect').value = offer.market;
            document.getElementById('offerValueInput').value = offer.value;
            document.getElementById('offerDateInput').value = offer.offerDate;
            document.getElementById('closingDateInput').value = offer.closingDate;
            document.getElementById('reminderDateInput').value = offer.reminderDate;
            document.getElementById('heatmapInput').value = offer.heatmap;
            document.getElementById('statusSelect').value = offer.status;
            document.getElementById('probabilityInput').value = offer.probability || 0;
            document.getElementById('visitsInput').value = offer.visits || 0;
            document.getElementById('revisionsInput').value = offer.revisions || 0;
            document.getElementById('commentsInput').value = offer.comments || '';

            if (offer.items && Array.isArray(offer.items)) {
                document.getElementById('pnitemsselect').value = offer.items.map(item => item.pn).join('\n');
                document.getElementById('quantidadeselect').value = offer.items.map(item => item.quantity).join('\n');
                document.getElementById('precoselect').value = offer.items.map(item => item.unitPrice).join('\n');
            } else {
                document.getElementById('pnitemsselect').value = '';
                document.getElementById('quantidadeselect').value = '';
                document.getElementById('precoselect').value = '';
            }
            
            openModal('offerModal');
        };

        window.handleEditSalesPerson = (id) => {
            const person = getById(db.salesTeam, id); if (!person) return;
            document.getElementById('editSalesPersonId').value = person.id;
            document.getElementById('salesPersonName').value = person.name;
            document.getElementById('salesPersonEmail').value = person.email;
            openModal('salesPersonModal');
        };

        window.handleEditCustomer = (id) => {
            const customer = getById(db.customers, id); if (!customer) return;
            document.getElementById('editCustomerId').value = customer.id;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerIndustry').value = customer.industry;
            document.getElementById('customerContactName').value = customer.contactName || '';
            document.getElementById('customerContactPhone').value = customer.contactPhone || '';
            document.getElementById('customerContactEmail').value = customer.contactEmail || '';
            document.getElementById('customerContactDepartment').value = customer.contactDepartment || '';
            openModal('customerModal');
        };

        document.getElementById('offerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editOfferId').value;
            
            const pnItemsStr = document.getElementById('pnitemsselect').value.trim();
            const quantitiesStr = document.getElementById('quantidadeselect').value.trim();
            const pricesStr = document.getElementById('precoselect').value.trim();

            const pnItems = pnItemsStr ? pnItemsStr.split('\n').map(s => s.trim()) : [];
            const quantities = quantitiesStr ? quantitiesStr.split('\n').map(s => s.trim()) : [];
            const prices = pricesStr ? pricesStr.split('\n').map(s => s.trim()) : [];

            if (pnItems.length !== quantities.length || pnItems.length !== prices.length) {
                showNotification('Erro: "PN Itens", "Quantidade" e "Preço Unitário" devem ter o mesmo número de linhas.', true);
                return;
            }

            const items = [];
            for (let i = 0; i < pnItems.length; i++) {
                items.push({
                    pn: pnItems[i],
                    quantity: parseInt(quantities[i], 10) || 1,
                    unitPrice: parseFloat(prices[i].replace(',', '.')) || 0.0
                });
            }

            const offerData = {
                salesPersonId: document.getElementById('salesPersonSelect').value,
                customerId: document.getElementById('customerSelect').value,
                market: document.getElementById('marketSelect').value,
                items: items,
                value: parseFloat(document.getElementById('offerValueInput').value),
                offerDate: document.getElementById('offerDateInput').value,
                closingDate: document.getElementById('closingDateInput').value,
                reminderDate: document.getElementById('reminderDateInput').value,
                heatmap: parseInt(document.getElementById('heatmapInput').value),
                status: document.getElementById('statusSelect').value,
                probability: parseInt(document.getElementById('probabilityInput').value) || 0,
                visits: parseInt(document.getElementById('visitsInput').value) || 0,
                revisions: parseInt(document.getElementById('revisionsInput').value) || 0,
                comments: document.getElementById('commentsInput').value,
            };
            try {
                if (id) {
                    await firestore.collection('offers').doc(id).update(offerData);
                } else {
                    offerData.offerNumber = generateOfferNumber();
                    await firestore.collection('offers').add(offerData);
                }
                closeModal('offerModal');
                showNotification('Proposta salva com sucesso!');
                loadDb();
            } catch (error) { showNotification('Erro ao salvar proposta.', true); console.error("Erro: ", error); }
        });

        document.getElementById('salesPersonForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editSalesPersonId').value;
            const personData = { name: document.getElementById('salesPersonName').value, email: document.getElementById('salesPersonEmail').value };
            try {
                if (id) {
                    await firestore.collection('salesTeam').doc(id).update(personData);
                } else {
                    await firestore.collection('salesTeam').add(personData);
                }
                closeModal('salesPersonModal');
                showNotification('Vendedor salvo com sucesso!');
                loadDb();
            } catch (error) { showNotification('Erro ao salvar vendedor.', true); console.error(error); }
        });

        document.getElementById('customerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editCustomerId').value;
            const customerData = { 
                name: document.getElementById('customerName').value, 
                industry: document.getElementById('customerIndustry').value,
                contactName: document.getElementById('customerContactName').value,
                contactPhone: document.getElementById('customerContactPhone').value,
                contactEmail: document.getElementById('customerContactEmail').value,
                contactDepartment: document.getElementById('customerContactDepartment').value
            };
            try {
                if (id) {
                    await firestore.collection('customers').doc(id).update(customerData);
                } else {
                    await firestore.collection('customers').add(customerData);
                }
                closeModal('customerModal');
                showNotification('Cliente salvo com sucesso!');
                loadDb();
            } catch (error) { showNotification('Erro ao salvar cliente.', true); console.error(error); }
        });
        
        window.handleDelete = async (event, type, id) => {
            event.stopPropagation();
            if (!confirm(`Tem certeza que deseja apagar este item?`)) return;
            const collectionName = (type === 'salesTeam' || type === 'customers') ? type : 'offers';
            try {
                 if (collectionName === 'salesTeam' && db.offers.some(o => o.salesPersonId === id)) {
                    showNotification('Não é possível apagar vendedor com propostas existentes.', true); return;
                }
                if (collectionName === 'customers' && db.offers.some(o => o.customerId === id)) {
                    showNotification('Não é possível apagar cliente com propostas existentes.', true); return;
                }
                await firestore.collection(collectionName).doc(id).delete();
                showNotification('Item apagado com sucesso!');
                loadDb();
            } catch(error) { showNotification('Erro ao apagar item.', true); console.error(error); }
        };

        window.exportOfferToPdf = async (event, offerId) => {
            event.stopPropagation(); // Prevent row click from opening edit modal
            const offer = getById(db.offers, offerId);
            if (!offer) {
                showNotification('Proposta não encontrada.', true);
                return;
            }

            const customer = getById(db.customers, offer.customerId) || {};
            const salesPerson = getById(db.salesTeam, offer.salesPersonId) || {};
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

            showNotification('Gerando PDF da proposta...');

            // Header
            pdf.setFontSize(20).setFont(undefined, 'bold');
            pdf.text('Proposta Comercial', 105, 20, { align: 'center' });

            // Info
            pdf.setFontSize(12).setFont(undefined, 'normal');
            pdf.text(`Proposta Nº: ${offer.offerNumber}`, 20, 40);
            pdf.text(`Data: ${new Date(offer.offerDate + 'T00:00:00').toLocaleDateString('pt-BR')}`, 190, 40, { align: 'right' });
            pdf.setLineWidth(0.5).line(20, 45, 190, 45);

            // Client and Salesperson
            let yPos = 55;
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold').text('Cliente:', 20, yPos);
            pdf.setFont(undefined, 'normal').text(customer.name || 'N/A', 40, yPos);
            pdf.setFont(undefined, 'bold').text('Vendedor:', 120, yPos);
            pdf.setFont(undefined, 'normal').text(salesPerson.name || 'N/A', 145, yPos);
            yPos += 7;
            pdf.setFont(undefined, 'bold').text('Contato:', 20, yPos);
            pdf.setFont(undefined, 'normal').text(customer.contactName || 'N/A', 40, yPos);
            pdf.setFont(undefined, 'bold').text('Email:', 120, yPos);
            pdf.setFont(undefined, 'normal').text(salesPerson.email || 'N/A', 145, yPos);
            yPos += 15;

            // Items Table
            pdf.setFontSize(14).setFont(undefined, 'bold').text('Itens da Proposta', 105, yPos, { align: 'center' });
            yPos += 8;

            const tableHeaders = ['Item (PN)', 'Quantidade', 'Preço Unitário', 'Subtotal'];
            const tableData = offer.items ? offer.items.map(item => {
                const subtotal = item.quantity * item.unitPrice;
                return [item.pn, item.quantity.toString(), formatCurrency(item.unitPrice), formatCurrency(subtotal)];
            }) : [];
            
            const tableStartY = yPos;
            const cellPadding = 4;
            const colWidths = [80, 25, 35, 30];
            let xPos = 20;

            pdf.setFont(undefined, 'bold').setFillColor(230, 230, 230).rect(20, yPos, 170, 8, 'F');
            tableHeaders.forEach((header, i) => {
                pdf.text(header, xPos + cellPadding, yPos + 6);
                xPos += colWidths[i];
            });
            yPos += 8;

            pdf.setFont(undefined, 'normal');
            tableData.forEach((row, rowIndex) => {
                xPos = 20;
                if (rowIndex % 2 !== 0) {
                    pdf.setFillColor(245, 245, 245).rect(20, yPos, 170, 8, 'F');
                }
                row.forEach((cell, i) => {
                    pdf.text(cell, xPos + cellPadding, yPos + 6);
                    xPos += colWidths[i];
                });
                yPos += 8;
            });
            pdf.setDrawColor(180, 180, 180).rect(20, tableStartY, 170, yPos - tableStartY);
            
            // Total
            yPos += 10;
            pdf.setFontSize(14).setFont(undefined, 'bold');
            pdf.text('Valor Total da Proposta:', 190, yPos, { align: 'right' });
            pdf.setFont(undefined, 'bold').text(formatCurrency(offer.value), 190, yPos + 7, { align: 'right' });

            // Comments
            yPos += 20;
            if(offer.comments){
                pdf.setFontSize(12).setFont(undefined, 'bold').text('Observações:', 20, yPos);
                yPos += 6;
                pdf.setFont(undefined, 'normal');
                const splitComments = pdf.splitTextToSize(offer.comments, 170);
                pdf.text(splitComments, 20, yPos);
            }
            
            // Footer
            pdf.setFontSize(10).setTextColor(150).text('Obrigado pela sua preferência!', 105, 280, { align: 'center' });

            pdf.save(`Proposta-${offer.offerNumber}.pdf`);
            showNotification('PDF da proposta exportado!', false);
        };

        function parseDate(dateString) {
            if (!dateString) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
            if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(dateString)) {
                const parts = dateString.split('/');
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                let year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                return `${year}-${month}-${day}`;
            }
            if (/^\d+$/.test(dateString) && parseInt(dateString) > 25569) {
                const date = new Date((parseInt(dateString) - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) return date.toISOString().split('T')[0];
            } catch (e) { console.warn("Could not parse date:", dateString); }
            return '';
        }

        document.getElementById('exportXlsxBtn').addEventListener('click', () => {
            const offersSheet = db.offers.map(o => ({
                'Proposta': o.offerNumber, 
                'Vendedor': getById(db.salesTeam, o.salesPersonId)?.name || 'N/A', 
                'Cliente': getById(db.customers, o.customerId)?.name || 'N/A', 
                'Mercado': o.market, 
                'Valor': o.value, 
                'Data da Proposta': o.offerDate, 
                'Data de Fechamento': o.closingDate, 
                'Heatmap': o.heatmap, 
                'Status': o.status, 
                'Probabilidade': o.probability || 0,
                'Visitas': o.visits || 0,
                'Revisões': o.revisions || 0,
                'Itens (JSON)': o.items ? JSON.stringify(o.items) : '[]',
                'Lembrete': o.reminderDate, 
                'Comentários': o.comments
            }));
            
            const salesTeamSheet = db.salesTeam.map(({id, ...rest}) => rest);
            const customersSheet = db.customers.map(c => ({ 'Nome': c.name, 'Setor': c.industry, 'Nome do Contato': c.contactName || '', 'Telefone': c.contactPhone || '', 'Email': c.contactEmail || '', 'Departamento': c.contactDepartment || '' }));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(offersSheet), "Ofertas");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(salesTeamSheet), "Vendedores");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(customersSheet), "Clientes");
            XLSX.writeFile(wb, "crm_backup.xlsx");
            showNotification("Backup em XLSX exportado!");
        });

        document.getElementById('exportJsonBtn').addEventListener('click', () => {
            const dataStr = JSON.stringify(db, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'crm_backup.json'; a.click(); URL.revokeObjectURL(url);
            showNotification('Backup em JSON exportado!');
        });
        
        document.getElementById('importXlsxBtn').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = async (event) => {
                    if (!confirm("Atenção: A importação irá APAGAR TODOS os dados existentes. Deseja continuar?")) return;
                    
                    try {
                        showNotification("Iniciando importação...");
                        await clearAllData();
                        
                        const workbook = XLSX.read(new Uint8Array(event.target.result), {type: 'array'});
                        if (!workbook.Sheets['Vendedores'] || !workbook.Sheets['Clientes'] || !workbook.Sheets['Ofertas']) {
                            throw new Error("O arquivo Excel deve conter as planilhas: Vendedores, Clientes e Ofertas");
                        }
                        
                        const salesTeamData = XLSX.utils.sheet_to_json(workbook.Sheets['Vendedores']);
                        for (const person of salesTeamData) {
                            if (person.Nome && person.Email) await firestore.collection('salesTeam').add({ name: person.Nome, email: person.Email });
                        }
                        
                        const customersData = XLSX.utils.sheet_to_json(workbook.Sheets['Clientes']);
                        for (const customer of customersData) {
                            if (customer.Nome && customer.Setor) await firestore.collection('customers').add({ name: customer.Nome, industry: customer.Setor, contactName: customer['Nome do Contato'] || '', contactPhone: customer.Telefone || '', contactEmail: customer.Email || '', contactDepartment: customer.Departamento || '' });
                        }
                        
                        await loadDb(); // Reload to get IDs
                        
                        const offersData = XLSX.utils.sheet_to_json(workbook.Sheets['Ofertas']);
                        const batch = firestore.batch();
                        
                        for (const offer of offersData) {
                            if (!offer['Proposta #'] || !offer['Vendedor'] || !offer['Cliente'] || !offer['Mercado'] || offer['Valor'] === undefined || !offer['Status']) {
                                console.warn("Proposta inválida ignorada:", offer); continue;
                            }
                            
                            const salesPerson = db.salesTeam.find(p => p.name.toLowerCase() === offer['Vendedor'].toLowerCase());
                            const customer = db.customers.find(c => c.name.toLowerCase() === offer['Cliente'].toLowerCase());

                            if (!salesPerson || !customer) {
                                console.warn("Vendedor ou cliente não encontrado para proposta:", offer); continue;
                            }
                            
                            let items = [];
                            if (offer['Itens (JSON)']) {
                                try {
                                    items = JSON.parse(offer['Itens (JSON)']);
                                    if (!Array.isArray(items)) items = [];
                                } catch (err) { console.warn("JSON de itens inválido:", offer['Proposta #']); items = []; }
                            }

                            const offerPayload = {
                                offerNumber: offer['Proposta #'], salesPersonId: salesPerson.id, customerId: customer.id, market: offer['Mercado'],
                                value: parseFloat(offer['Valor'] || 0), offerDate: parseDate(offer['Data da Proposta']) || '', closingDate: parseDate(offer['Data de Fechamento']) || '',
                                heatmap: parseInt(offer['Heatmap']) || 5, status: offer['Status'].toLowerCase(), probability: parseInt(offer['Probabilidade']) || 0,
                                visits: parseInt(offer['Visitas']) || 0, revisions: parseInt(offer['Revisões']) || 0, reminderDate: parseDate(offer['Lembrete']) || '',
                                items: items, comments: offer['Comentários'] || ''
                            };
                            batch.set(firestore.collection('offers').doc(), offerPayload);
                        }
                        await batch.commit();
                        showNotification('Importação concluída com sucesso!');
                        loadDb();
                    } catch (err) {
                        console.error("Erro de importação: ", err);
                        showNotification('Erro na importação: ' + err.message, true);
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        });

        document.getElementById('exportFunnelXlsx').addEventListener('click', () => {
            const salesPersonFilter = document.getElementById('funnelSalesPersonFilter').value;
            const customerFilter = document.getElementById('funnelCustomerFilter').value;
            const heatmapFilter = document.getElementById('funnelHeatmapFilter').value;
            const closingDateFilter = document.getElementById('funnelClosingDateFilter').value;
            const urgencyFilter = document.getElementById('funnelUrgencyFilter').value;
            
            let filteredOffers = db.offers.filter(offer => {
                const heatmapMatch = !heatmapFilter || (heatmapFilter === '1-3' && offer.heatmap <= 3) || (heatmapFilter === '4-7' && offer.heatmap >= 4 && offer.heatmap <= 7) || (heatmapFilter === '8-10' && offer.heatmap >= 8);
                const closingDateMatch = !closingDateFilter || offer.closingDate === closingDateFilter;
                const urgencyInfo = calculateUrgency(offer);
                const urgencyLevel = getUrgencyInfo(urgencyInfo.score, urgencyInfo.daysUntilClosing).level;
                const urgencyMatch = !urgencyFilter || urgencyLevel === urgencyFilter;
                return (!salesPersonFilter || offer.salesPersonId === salesPersonFilter) && (!customerFilter || offer.customerId === customerFilter) && heatmapMatch && closingDateMatch && urgencyMatch;
            });
            
            const funnelSheet = filteredOffers.map(o => {
                const urgencyInfo = calculateUrgency(o);
                const urgency = getUrgencyInfo(urgencyInfo.score, urgencyInfo.daysUntilClosing);
                return {
                    'Proposta #': o.offerNumber, 'Vendedor': getById(db.salesTeam, o.salesPersonId)?.name || 'N/A', 'Cliente': getById(db.customers, o.customerId)?.name || 'N/A', 
                    'Mercado': o.market, 'Valor': o.value, 'Valor Esperado': o.value * (o.probability / 100), 'Data da Proposta': o.offerDate, 'Data de Fechamento': o.closingDate, 
                    'Heatmap': o.heatmap, 'Status': STATUSES[o.status] || o.status, 'Probabilidade': o.probability || 0, 'Visitas': o.visits || 0, 'Revisões': o.revisions || 0,
                    'Urgência': urgency.label, 'Pontuação de Urgência': urgencyInfo.score, 'Dias até Fechamento': urgencyInfo.daysUntilClosing, 'Lembrete': o.reminderDate, 'Comentários': o.comments
                };
            });
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(funnelSheet), "Funil de Vendas");
            XLSX.writeFile(wb, "funil_vendas.xlsx");
            showNotification("Funil exportado para XLSX!");
        });
        
        document.getElementById('exportFunnelPdf').addEventListener('click', async () => {
            showNotification('Gerando PDF do funil...');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            
            pdf.setFontSize(20).text('Relatório do Funil de Vendas', 148, 15, { align: 'center' });
            pdf.setFontSize(10).text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 148, 22, { align: 'center' });

            const canvas = document.getElementById('funnelOverviewChart');
            const imgData = canvas.toDataURL('image/png', 1.0);
            pdf.addImage(imgData, 'PNG', 15, 30, 267, 100);
            
            pdf.save('relatorio_funil_vendas.pdf');
            showNotification('PDF do funil exportado com sucesso!');
        });

        async function clearCollection(collectionName) {
            const snapshot = await firestore.collection(collectionName).get();
            const batch = firestore.batch();
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
        }

        async function clearAllData() {
            showNotification("Limpando banco de dados...");
            await Promise.all([ clearCollection('offers'), clearCollection('customers'), clearCollection('salesTeam') ]);
        }

        document.getElementById('clearDbBtn').addEventListener('click', async () => {
            if (confirm('TEM CERTEZA ABSOLUTA? Esta ação apagará TODOS os dados no banco de dados da nuvem PERMANENTEMENTE.')) {
                try {
                    await clearAllData();
                    showNotification('Todos os dados foram apagados.');
                    loadDb();
                } catch (error) {
                    showNotification('Erro ao limpar o banco de dados.', true);
                    console.error("Erro ao limpar: ", error);
                }
            }
        });
        
        document.getElementById('addOfferBtn').addEventListener('click', () => { 
            document.getElementById('offerForm').reset();
            document.getElementById('editOfferId').value = '';
            openModal('offerModal');
        });
        document.getElementById('addSalesPersonBtn').addEventListener('click', () => { 
            document.getElementById('salesPersonForm').reset();
            document.getElementById('editSalesPersonId').value = '';
            openModal('salesPersonModal');
        });
        document.getElementById('addCustomerBtn').addEventListener('click', () => { 
            document.getElementById('customerForm').reset();
            document.getElementById('editCustomerId').value = '';
            openModal('customerModal');
        });
        
        document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal').id)));
        
        document.querySelectorAll('.filter-select').forEach(sel => sel.addEventListener('change', renderOffersTable));

        document.getElementById('resetFiltersBtn').addEventListener('click', () => {
            document.querySelectorAll('.filters .filter-select').forEach(select => {
                select.value = '';
            });
            renderOffersTable();
        });

        ['funnelSalesPersonFilter', 'funnelCustomerFilter', 'funnelHeatmapFilter', 'funnelClosingDateFilter', 'funnelUrgencyFilter'].forEach(id => {
            document.getElementById(id).addEventListener('change', renderSalesFunnel);
        });

        document.querySelectorAll('#offersTable th[data-sort]').forEach(headerCell => {
            headerCell.addEventListener('click', () => {
                const column = headerCell.dataset.sort;
                sortState.column = column;
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                renderOffersTable();
            });
        });

        document.querySelectorAll('.menu-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabId = e.currentTarget.dataset.tab;
                document.querySelectorAll('.tab-content.active, .menu-link.active').forEach(el => el.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                e.currentTarget.classList.add('active');
                document.querySelector('.page-title').textContent = e.currentTarget.textContent.trim();
                if (window.innerWidth <= 992) document.getElementById('sidebar').classList.remove('active');
                if (tabId === 'sales-funnel') renderSalesFunnel();
            });
        });
        
        document.querySelectorAll('.tabs .tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const subtabId = e.target.dataset.subtab;
                const parent = e.target.closest('.tab-content');
                parent.querySelectorAll('.tab-content.active, .tab.active').forEach(el => el.classList.remove('active'));
                parent.querySelector(`#${subtabId}`).classList.add('active');
                e.target.classList.add('active');
            });
        });
        
        document.getElementById('mobileMenuBtn').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('active'));

        async function exportElementToPdf(elementId, fileName) {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById(elementId);
            if (!element) return;
            showNotification('Gerando PDF...');
            const canvas = await html2canvas(element, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [canvas.width, canvas.height] });
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save(fileName);
            showNotification('PDF exportado com sucesso!');
        }
        
        document.getElementById('exportKpisPdf').addEventListener('click', () => exportElementToPdf('kpis', 'relatorio_kpis.pdf'));
        document.getElementById('exportReportsPdf').addEventListener('click', () => exportElementToPdf('reports', 'relatorios_vendas.pdf'));
        
        renderSalesFunnelVisualization();
        loadDb();
    });
</script>
</body>
</html>
