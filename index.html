<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM ProNeg√≥cios</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <!-- PDF & Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
        :root {
            --primary-color: #0a0a0a;
            --secondary-color: #1a1a1a;
            --accent-color: #4a90e2;
            --text-color: #ffffff;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --info-color: #9C27B0;
            --border-color: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }


.status-delayed-row { background-color: #450a0a !important; }
.status-expired-row { background-color: #3b0d3b !important; }

        body {
            background-color: var(--primary-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: var(--secondary-color);
            padding: 20px;
            transition: all 0.3s ease;
            border-right: 1px solid var(--border-color);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-color);
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text-color);
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-link i {
            margin-right: 10px;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--secondary-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 10px;
        }

        .card-value {
            font-size: 24px;
            font-weight: bold;
        }

        /* Offers Table */
        .offers-section {
            background-color: var(--secondary-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn, .action-btn {
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-color);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .filter-btn.active, .action-btn:hover {
            background-color: var(--accent-color);
        }

        .filter-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        th::after {
            content: '‚Üï';
            position: absolute;
            right: 10px;
            opacity: 0.5;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-offered {
            background-color: transparent;
            border: 1px solid #aaa;
        }

        .status-quoted {
            background-color: var(--success-color);
        }

        .status-delayed {
            background-color: var(--danger-color);
        }

        .status-expired {
            background-color: var(--info-color);
        }

        .status-won {
            background-color: var(--success-color);
        }

        .status-lost {
            background-color: var(--danger-color);
        }

        .heatmap-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .heatmap-1 { background-color: #ff0000; }
        .heatmap-2 { background-color: #ff3300; }
        .heatmap-3 { background-color: #ff6600; }
        .heatmap-4 { background-color: #ff9900; }
        .heatmap-5 { background-color: #ffcc00; }
        .heatmap-6 { background-color: #ffff00; }
        .heatmap-7 { background-color: #ccff00; }
        .heatmap-8 { background-color: #99ff00; }
        .heatmap-9 { background-color: #66ff00; }
        .heatmap-10 { background-color: #33ff00; }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--secondary-color);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color:  rgba(92, 8, 236, 0.845);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-col {
            flex: 1;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        /* KPI Section */
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background-color: var(--secondary-color);
            border-radius: 8px;
            padding: 20px;
        }

        .kpi-title {
            font-size: 16px;
            margin-bottom: 15px;
        }

        .kpi-chart {
            height: 200px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
        }

        .kpi-bar {
            width: 30px;
            background-color: var(--accent-color);
            border-radius: 3px 3px 0 0;
        }

        /* Enhanced Sales Funnel Styles */
        .funnel-viz-container {
            width: 100%;
            margin: 30px 0;
            padding: 20px;
            background-color: var(--secondary-color);
            border-radius: 8px;
        }

        .funnel-viz {
            width: 100%;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin-bottom: 20px;
            position: relative;
        }

        .funnel-bar {
            width: 80px;
            margin: 0 10px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            background: linear-gradient(to top, var(--accent-color), #2a6bb9);
        }

        .funnel-bar:hover {
            transform: scale(1.05);
            filter: brightness(1.2);
        }

        .funnel-bar::after {
            content: attr(data-count);
            position: absolute;
            top: -25px;
            left: 0;
            width: 100%;
            text-align: center;
            font-weight: 600;
            color: var(--text-color);
        }

        .funnel-bar::before {
            content: attr(data-stage);
            position: absolute;
            bottom: -30px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 14px;
            color: #aaa;
        }

        .stage-1 { height: 250px; background: linear-gradient(to top, #4a90e2, #2a6bb9); }
        .stage-2 { height: 200px; background: linear-gradient(to top, #5da0e8, #3b7bc3); }
        .stage-3 { height: 150px; background: linear-gradient(to top, #70b0ee, #4c8bcd); }
        .stage-4 { height: 100px; background: linear-gradient(to top, #83c0f4, #5d9bd7); }
        .stage-5 { height: 50px; background: linear-gradient(to top, #96d0fa, #6eabe1); }

        .funnel-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .funnel-stat-card {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }

        .funnel-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .funnel-stat-label {
            font-size: 12px;
            color: #aaa;
        }

        .funnel-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .funnel-stage {
            background-color: var(--secondary-color);
            border-radius: 8px;
            padding: 20px;
            min-height: 120px;
            transition: all 0.3s ease;
        }

        .funnel-stage:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .funnel-stage-title {
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stage-count {
            background-color: var(--accent-color);
            color: white;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 14px;
            font-weight: 500;
        }

        .funnel-stage-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            min-height: 80px;
        }

        .funnel-item {
            background: linear-gradient(135deg, #2a2a2a, #1f1f1f);
            border-radius: 8px;
            padding: 15px;
            cursor: move;
            transition: all 0.3s ease;
            border-left: 4px solid var(--accent-color);
            position: relative;
            overflow: hidden;
        }

        .funnel-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .funnel-item.high-priority {
            border-left-color: var(--success-color);
        }

        .funnel-item.medium-priority {
            border-left-color: var(--warning-color);
        }

        .funnel-item.low-priority {
            border-left-color: var(--danger-color);
        }

        .customer-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .customer-company {
            color: #aaa;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .funnel-item-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .heatmap-indicator-funnel {
            display: flex;
            align-items: center;
            font-size: 12px;
        }

        .heatmap-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .item-value {
            font-weight: 600;
            color: var(--accent-color);
            font-size: 12px;
        }

        .funnel-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .funnel-filter-btn {
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-color);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
        }

        .funnel-filter-btn.active, .funnel-filter-btn:hover {
            background-color: var(--accent-color);
        }

        .heatmap-legend {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        .legend-text {
            font-size: 14px;
            color: #aaa;
        }

        .priority-high { background-color: var(--success-color); }
        .priority-medium { background-color: var(--warning-color); }
        .priority-low { background-color: var(--danger-color); }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #777;
            font-style: italic;
            grid-column: 1 / -1;
        }

        .drag-over {
            background-color: rgba(74, 144, 226, 0.1);
            border: 2px dashed var(--accent-color);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 10px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr 1fr;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .funnel-stage-content {
                grid-template-columns: 1fr;
            }
            
            .funnel-viz {
                height: 200px;
            }
            
            .funnel-bar {
                width: 50px;
                margin: 0 5px;
            }

            .funnel-bar::before {
                font-size: 10px;
                bottom: -25px;
            }

            .funnel-bar::after {
                font-size: 12px;
                top: -20px;
            }
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            border-bottom: 2px solid var(--accent-color);
            color: var(--accent-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }


 .toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: var(--accent-color);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

/* Email reminder button */
    .email-reminder-btn {
      background-color: var(--success-color);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 5px;
    }

    .email-reminder-btn:hover {
      background-color: #3d8b40;
    }

    /* Email reminder modal */
    .email-modal textarea {
      height: 150px;
      resize: vertical;
    }

th[data-sort] {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 25px !important;
}

th[data-sort]:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

/* Remove the old ::after styles and use classes instead */
th[data-sort]::after {
    content: '‚Üï';
    position: absolute;
    right: 10px;
    opacity: 0.5;
    font-size: 12px;
}

th.sort-asc::after,
th.sort-desc::after {
    content: '' !important; /* Remove the default arrows */
}

/* Style for the dynamically added indicators */
.sort-indicator {
    margin-left: 5px;
    font-weight: bold;
}

/* Form Check Styles */
.form-check {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.form-check-input {
    margin-right: 8px;
    width: 16px;
    height: 16px;
}

.form-check-label {
    color: var(--text-color);
    font-size: 14px;
}

/* Password field styling */
.password-field {
    position: relative;
}

.toggle-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-color);
    cursor: pointer;
}

.export-options {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .export-option {
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .export-option:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .export-option.active {
      background-color: var(--accent-color);
    }

    .format-info {
      font-size: 12px;
      color: #aaa;
      margin-top: 5px;
    }



    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">CRM System</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-tab="dashboard">
                        <i>üìä</i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="customers">
                        <i>üë•</i> Clientes
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="offers">
                        <i>üìã</i> Ofertas
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="funnel">
                        <i>üìà</i> Funil de Vendas
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="kpis">
                        <i>üìä</i> KPIs
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="reports">
                        <i>üìÑ</i> Relat√≥rios
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="management">
                        <i>‚öôÔ∏è</i> Configura√ß√µes
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Product Modal -->
<div id="product-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="product-modal-title">Novo Produto</h2>
            <button class="close-btn">&times;</button>
        </div>
        <form id="product-form">
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label class="form-label" for="product-code">C√≥digo do Produto</label>
                        <input type="text" class="form-control" id="product-code" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="product-description">Descri√ß√£o</label>
                        <input type="text" class="form-control" id="product-description" required>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label class="form-label" for="product-price">Pre√ßo Unit√°rio (R$)</label>
                        <input type="number" class="form-control" id="product-price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="product-category">Categoria</label>
                        <select class="form-control" id="product-category" required>
                            <option value="">Selecione uma categoria</option>
                            <option value="Equipamentos">Equipamentos</option>
                            <option value="Pe√ßas">Pe√ßas</option>
                            <option value="Servi√ßos">Servi√ßos</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" for="product-notes">Observa√ß√µes</label>
                <textarea class="form-control" id="product-notes" rows="3"></textarea>
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Salvar Produto</button>
                <button type="button" class="btn btn-secondary" id="cancel-product">Cancelar</button>
            </div>
        </form>
    </div>
</div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1 class="page-title" id="page-title">Dashboard</h1>
                <div class="user-info">
                    <div class="user-avatar">JS</div>
                    <span>Jo√£o Silva</span>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <!-- Dashboard Cards -->
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-title">Total de Ofertas</div>
                        <div class="card-value" id="total-offers">0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Valor Total</div>
                        <div class="card-value" id="total-value">R$ 0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Taxa de Convers√£o</div>
                        <div class="card-value" id="conversion-rate">0%</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Ofertas Atrasadas</div>
                        <div class="card-value" id="delayed-offers">0</div>
                    </div>
                </div>

                <!-- Offers Section -->
                <section class="offers-section">
                    <div class="section-header">
                        <h2 class="section-title">Ofertas</h2>
                        <button class="filter-btn" id="new-offer-btn">+ Nova Oferta</button>
                    </div>


                    <!-- Toggle for showing/hiding lost offers -->
                    <div class="toggle-container">
                        <span>Mostrar ofertas perdidas:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="show-lost-offers">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>



                    
                    <div class="filters">
                        <button class="filter-btn active" data-filter="all">Todas</button>
                        <button class="filter-btn" data-filter="my">Minhas</button>
                        <button class="filter-btn" data-filter="delayed">Atrasadas</button>
                        <button class="filter-btn" data-filter="high-priority">Com Alta Prioridade</button>
                    </div>

                    <table id="offers-table">
                        <thead>
                            <tr>
                                <th data-sort="id">N¬∫ Oferta</th>
                                <th data-sort="customer">Cliente</th>
                                <th data-sort="salesperson">Vendedor</th>
                                <th data-sort="date">Data</th>
                                <th data-sort="value">Valor Total</th>
                                <th data-sort="heatmap">Mapa de Calor</th>
                                <th data-sort="status">Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="offers-tbody">
                            <!-- Offers will be populated by JavaScript -->
                        </tbody>
                    </table>
                </section>









                <!-- KPI Section -->
                <section class="kpi-section">
                    <div class="kpi-card">
                        <h3 class="kpi-title">Convers√£o de Ofertas</h3>
                        <div class="kpi-chart" id="conversion-chart">
                            <!-- Chart will be populated by JavaScript -->
                        </div>
                    </div>
                    <div class="kpi-card">
                        <h3 class="kpi-title">Motivos de Perda</h3>
                        <div class="kpi-chart" id="loss-reasons-chart">
                            <!-- Chart will be populated by JavaScript -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- Customers Tab -->
            <div id="customers" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Gest√£o de Clientes</h2>
                    <button class="filter-btn" id="new-customer-btn">+ Novo Cliente</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Telefone</th>
                            <th>Empresa</th>
                            <th>Segmento</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="customers-tbody">
                        <!-- Customers will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>









            <!-- Offers Tab -->
            <div id="offers" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Todas as Ofertas</h2>
                    <button class="filter-btn" id="new-offer-btn2">+ Nova Oferta</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>N¬∫ Oferta</th>
                            <th>Cliente</th>
                            <th>Vendedor</th>
                            <th>Data</th>
                            <th>Valor Total</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="all-offers-tbody">
                        <!-- All offers will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Enhanced Sales Funnel Tab -->
            <div id="funnel" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Funil de Vendas Automatizado</h2>
                    <button class="filter-btn" id="auto-classify-btn">Classificar Automaticamente</button>
                </div>
                
                <div class="funnel-controls">
                    <button class="funnel-filter-btn active" data-funnel-filter="all">Todos os Clientes</button>
                    <button class="funnel-filter-btn" data-funnel-filter="high">Alta Prioridade</button>
                    <button class="funnel-filter-btn" data-funnel-filter="medium">M√©dia Prioridade</button>
                    <button class="funnel-filter-btn" data-funnel-filter="low">Baixa Prioridade</button>
                </div>

                <div class="funnel-viz-container">
                    <div class="funnel-viz">
                        <div class="funnel-bar stage-1" data-stage="Qualifica√ß√£o" data-count="0"></div>
                        <div class="funnel-bar stage-2" data-stage="Interesse" data-count="0"></div>
                        <div class="funnel-bar stage-3" data-stage="Proposta" data-count="0"></div>
                        <div class="funnel-bar stage-4" data-stage="Negocia√ß√£o" data-count="0"></div>
                        <div class="funnel-bar stage-5" data-stage="Fechamento" data-count="0"></div>
                    </div>

                    <div class="funnel-stats">
                        <div class="funnel-stat-card">
                            <div class="funnel-stat-value" id="funnel-total-customers">0</div>
                            <div class="funnel-stat-label">Total de Clientes</div>
                        </div>
                        <div class="funnel-stat-card">
                            <div class="funnel-stat-value" id="funnel-avg-heatmap">0</div>
                            <div class="funnel-stat-label">Mapa de Calor M√©dio</div>
                        </div>
                        <div class="funnel-stat-card">
                            <div class="funnel-stat-value" id="funnel-conversion-rate">0%</div>
                            <div class="funnel-stat-label">Taxa de Convers√£o</div>
                        </div>
                        <div class="funnel-stat-card">
                            <div class="funnel-stat-value" id="funnel-total-value">R$ 0</div>
                            <div class="funnel-stat-label">Valor Total</div>
                        </div>
                    </div>
                </div>

                <div class="funnel-container">
                    <div class="funnel-stage">
                        <div class="funnel-stage-title">
                            <span>Qualifica√ß√£o Inicial</span>
                            <span class="stage-count">0</span>
                        </div>
                        <div class="funnel-stage-content" id="stage-qualification">
                            <div class="empty-state">Arraste ofertas para esta etapa</div>
                        </div>
                    </div>

                    <div class="funnel-stage">
                        <div class="funnel-stage-title">
                            <span>Demonstra√ß√£o de Interesse</span>
                            <span class="stage-count">0</span>
                        </div>
                        <div class="funnel-stage-content" id="stage-interest">
                            <div class="empty-state">Arraste ofertas para esta etapa</div>
                        </div>
                    </div>

                    <div class="funnel-stage">
                        <div class="funnel-stage-title">
                            <span>Proposta Enviada</span>
                            <span class="stage-count">0</span>
                        </div>
                        <div class="funnel-stage-content" id="stage-proposal">
                            <div class="empty-state">Arraste ofertas para esta etapa</div>
                        </div>
                    </div>

                    <div class="funnel-stage">
                        <div class="funnel-stage-title">
                            <span>Negocia√ß√£o</span>
                            <span class="stage-count">0</span>
                        </div>
                        <div class="funnel-stage-content" id="stage-negotiation">
                            <div class="empty-state">Arraste ofertas para esta etapa</div>
                        </div>
                    </div>

                    <div class="funnel-stage">
                        <div class="funnel-stage-title">
                            <span>Fechamento</span>
                            <span class="stage-count">0</span>
                        </div>
                        <div class="funnel-stage-content" id="stage-closing">
                            <div class="empty-state">Arraste ofertas para esta etapa</div>
                        </div>
                    </div>
                </div>

                <div class="heatmap-legend">
                    <div class="legend-item">
                        <div class="legend-color priority-high"></div>
                        <div class="legend-text">Alta Prioridade (8-10)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color priority-medium"></div>
                        <div class="legend-text">M√©dia Prioridade (5-7)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color priority-low"></div>
                        <div class="legend-text">Baixa Prioridade (1-4)</div>
                    </div>
                </div>
            </div>

            <!-- KPIs Tab -->
            <div id="kpis" class="tab-content">
                <h2 class="section-title">Indicadores de Performance (KPIs)</h2>
                <div class="filters">
                    <input type="date" id="start-date" class="form-control">
                    <input type="date" id="end-date" class="form-control">
                    <button class="filter-btn" id="apply-kpi-filter">Aplicar Filtro</button>
                </div>
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-title">Taxa de Convers√£o</div>
                        <div class="card-value" id="kpi-conversion">0%</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Cota√ß√µes Revisadas</div>
                        <div class="card-value" id="kpi-revised">0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Visitas por Oferta</div>
                        <div class="card-value" id="kpi-visits">0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Motivo Principal de Perda</div>
                        <div class="card-value" id="kpi-main-loss">-</div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <h2 class="section-title">Relat√≥rios</h2>
                <div class="filters">
                    <input type="date" id="report-start" class="form-control">
                    <input type="date" id="report-end" class="form-control">
                    <select id="report-type" class="form-control">
                        <option value="sales">Vendas por Vendedor</option>
                        <option value="segment">Vendas por Segmento</option>
                        <option value="status">Ofertas por Status</option>
                    </select>
                    <button class="filter-btn" id="generate-report">Gerar Relat√≥rio</button>
                    <button class="filter-btn" id="export-pdf">Exportar PDF</button>
                    <button class="filter-btn" id="export-excel">Exportar Excel</button>
                </div>
                <div id="report-results">
                    <!-- Report results will be displayed here -->
                </div>
            </div>

            <!-- Management Tab -->
            <div id="management" class="tab-content">
            <div class="tab-navigation">
                <button class="tab-btn active" data-management-tab="data">Gest√£o de Dados</button>
                <button class="tab-btn" data-management-tab="users">Utilizadores</button>
                <button class="tab-btn" data-management-tab="products">Produtos</button>
            </div>
            
            <div id="data-management" class="management-tab active">
                <h3 class="section-title">Gest√£o de Dados</h3>
                
                <!-- Export Section -->
                <div class="form-group">
                    <label class="form-label">Exportar Dados</label>
                    <div class="export-options">
                        <button class="export-option active" data-format="csv">Exportar como CSV</button>
                        <button class="export-option" data-format="xlsx">Exportar como Excel</button>
                        <button class="export-option" data-format="json">Exportar como JSON</button>
                    </div>
                    <div class="format-info" id="export-info">
                        CSV: Ideal para abrir em Excel, Google Sheets ou outros programas de planilha
                    </div>
                    <button class="filter-btn" id="export-all">Exportar Todos os Dados</button>
                </div>
                
                <!-- Import Section -->
                <div class="form-group">
                    <label class="form-label">Importar Dados</label>
                    <div class="export-options">
                        <button class="export-option active" data-import-format="csv">Importar CSV</button>
                        <button class="export-option" data-import-format="xlsx">Importar Excel</button>
                        <button class="export-option" data-import-format="json">Importar JSON</button>
                    </div>
                    <div class="format-info" id="import-info">
                        CSV: Formato de planilha com valores separados por v√≠rgulas
                    </div>
                    <div id="import-area" style="margin-top: 20px; display: none;">
                        <input type="file" id="import-file" class="form-control" accept=".csv,.xlsx,.json">
                        <button class="filter-btn" id="confirm-import">Confirmar Importa√ß√£o</button>
                    </div>
                    <button class="filter-btn" id="import-data">Importar Dados</button>
                </div>
                
                <!-- Clear Data Section -->
                <div class="form-group">
                    <button class="filter-btn btn-danger" id="clear-data">Limpar Todos os Dados</button>
                </div>
            </div>
                
                <div id="users-management" class="management-tab">
                    <h3 class="section-title">Gest√£o de Utilizadores</h3>
                    <button class="filter-btn" id="new-user-btn">+ Novo Utilizador</button>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Perfil</th>
                                <th>Estado</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <!-- Users will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>




<!-- User Modal -->
<div id="user-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="user-modal-title">Novo Utilizador</h2>
            <button class="close-btn">&times;</button>
        </div>
        <form id="user-form">
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label class="form-label" for="user-name">Nome Completo</label>
                        <input type="text" class="form-control" id="user-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="user-email">Email</label>
                        <input type="email" class="form-control" id="user-email" required>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label class="form-label" for="user-role">Perfil</label>
                        <select class="form-control" id="user-role" required>
                            <option value="">Selecione um perfil</option>
                            <option value="Administrador">Administrador</option>
                            <option value="Vendedor">Vendedor</option>
                            <option value="Gestor">Gestor</option>
                            <option value="Consultor">Consultor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="user-password">Senha</label>
                        <input type="password" class="form-control" id="user-password" required>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label class="form-label" for="user-phone">Telefone</label>
                        <input type="tel" class="form-control" id="user-phone">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label class="form-label" for="user-department">Departamento</label>
                        <select class="form-control" id="user-department">
                            <option value="">Selecione um departamento</option>
                            <option value="Vendas">Vendas</option>
                            <option value="Marketing">Marketing</option>
                            <option value="TI">TI</option>
                            <option value="Financeiro">Financeiro</option>
                            <option value="RH">Recursos Humanos</option>
                            <option value="Opera√ß√µes">Opera√ß√µes</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" for="user-notes">Observa√ß√µes</label>
                <textarea class="form-control" id="user-notes" rows="3" placeholder="Informa√ß√µes adicionais sobre o utilizador..."></textarea>
            </div>
            <div class="form-group">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="user-active" checked>
                    <label class="form-check-label" for="user-active">Utilizador Ativo</label>
                </div>
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Salvar Utilizador</button>
                <button type="button" class="btn btn-secondary" id="cancel-user">Cancelar</button>
            </div>
        </form>
    </div>
</div>




                
                <div id="products-management" class="management-tab">
                    <h3 class="section-title">Gest√£o de Produtos</h3>
                    <button class="filter-btn" id="new-product-btn">+ Novo Produto</button>
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Descri√ß√£o</th>
                                <th>Pre√ßo Unit√°rio</th>
                                <th>Categoria</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody">
                            <!-- Products will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Your existing modals remain the same -->
    <!-- Offer Modal -->
        <div id="offer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="offer-modal-title">Nova Oferta</h2>
                <button class="close-btn">&times;</button>
            </div>
            <form id="offer-form">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="offer-customer">Cliente</label>
                            <select class="form-control" id="offer-customer" required>
                                <option value="">Selecione um cliente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="offer-salesperson">Vendedor</label>
                            <select class="form-control" id="offer-salesperson" required>
                                <option value="">Selecione um vendedor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="offer-date">Data da Oferta</label>
                            <input type="date" class="form-control" id="offer-date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="offer-reminder">Data de Lembrete</label>
                            <input type="date" class="form-control" id="offer-reminder">
                        </div>
                        <!-- NEW FIELD: Expected Closing Date -->
                        <div class="form-group">
                            <label class="form-label" for="offer-closing-date">Data Prevista de Fechamento</label>
                            <input type="date" class="form-control" id="offer-closing-date">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="offer-status">Status</label>
                            <select class="form-control" id="offer-status" required>
                                <option value="offered">Ofertado</option>
                                <option value="quoted">Cotado</option>
                                <option value="negotiating">Negociando</option>
                                <option value="won">Ganho</option>
                                <option value="lost">Perdido</option>
                            </select>
                        </div>
                        <!-- NEW FIELD: Reason for Loss (only shown when status is "lost") -->
                        <div class="form-group" id="loss-reason-group" style="display: none;">
                            <label class="form-label" for="offer-loss-reason">Motivo da Perda</label>
                            <select class="form-control" id="offer-loss-reason">
                                <option value="">Selecione um motivo</option>
                                <option value="price">Pre√ßo</option>
                                <option value="tech-specs">Especifica√ß√µes T√©cnicas</option>
                                <option value="competitors">Concorrentes</option>
                                <option value="project-cancelled">Projeto Cancelado pelo Cliente</option>
                                <option value="brand">N√£o Quer Nossa Marca</option>
                                <option value="other">Outro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="offer-chance">% Chance de Fechamento</label>
                            <input type="number" class="form-control" id="offer-chance" min="0" max="100" value="50">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="offer-market">Mercado</label>
                            <select class="form-control" id="offer-market" required>
                                <option value="industrial">Industrial</option>
                                <option value="telecom">Telecom</option>
                                <option value="data-center">Data Center</option>
                                <option value="mission-critical">Miss√£o Cr√≠tica</option>
                                <option value="hospital">Hospitalar</option>
                                <option value="customized">Personalizado</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="offer-products">Produtos</label>
                    <div id="offer-products">
                        <div class="product-row form-row">
                            <div class="form-col">
                                <select class="form-control product-select">
                                    <option value="">Selecione um produto</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <input type="number" class="form-control product-quantity" placeholder="Quantidade" min="1">
                            </div>
                            <div class="form-col">
                                <input type="number" class="form-control product-price" placeholder="Pre√ßo Unit√°rio" step="0.01" min="0">
                            </div>
                            <div class="form-col">
                                <button type="button" class="btn btn-danger remove-product">Remover</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" id="add-product">+ Adicionar Produto</button>
                </div>
                <div class="form-group">
                    <label class="form-label" for="offer-comments">Coment√°rios</label>
                    <textarea class="form-control" id="offer-comments" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="offer-attachment">Anexar Arquivo</label>
                    <input type="file" class="form-control" id="offer-attachment">
                    <!-- Display for existing attachment -->
                    <div id="attachment-display" style="margin-top: 10px;"></div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Salvar Oferta</button>
                    <button type="button" class="btn btn-secondary" id="cancel-offer">Cancelar</button>
                </div>
            </form>
        </div>
    </div>



<!-- Email Reminder Modal -->
    <div id="email-reminder-modal" class="modal email-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Enviar Lembrete por Email</h2>
                <button class="close-btn">&times;</button>
            </div>
            <form id="email-reminder-form">
                <div class="form-group">
                    <label class="form-label" for="email-to">Para</label>
                    <input type="email" class="form-control" id="email-to" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="email-subject">Assunto</label>
                    <input type="text" class="form-control" id="email-subject" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="email-message">Mensagem</label>
                    <textarea class="form-control" id="email-message" rows="6" required></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Enviar Email</button>
                    <button type="button" class="btn btn-secondary" id="cancel-email">Cancelar</button>
                </div>
            </form>
        </div>
    </div>






    <!-- Customer Modal -->
    <div id="customer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="customer-modal-title">Novo Cliente</h2>
                <button class="close-btn">&times;</button>
            </div>
            <form id="customer-form">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="customer-name">Nome</label>
                            <input type="text" class="form-control" id="customer-name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="customer-email">Email</label>
                            <input type="email" class="form-control" id="customer-email">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="customer-phone">Telefone</label>
                            <input type="tel" class="form-control" id="customer-phone">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="customer-company">Empresa</label>
                            <input type="text" class="form-control" id="customer-company" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="customer-segment">Segmento</label>
                            <select class="form-control" id="customer-segment" required>
                                <option value="industrial">Industrial</option>
                                <option value="telecom">Telecom</option>
                                <option value="data-center">Data Center</option>
                                <option value="mission-critical">Miss√£o Cr√≠tica</option>
                                <option value="hospital">Hospitalar</option>
                                <option value="customized">Personalizado</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Salvar Cliente</button>
                    <button type="button" class="btn btn-secondary" id="cancel-customer">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // Sample data structure
     const sampleData = {
        customers: [
            { id: 1, name: "Jo√£o Silva", email: "joao@empresa.com", phone: "(11) 99999-9999", company: "Empresa ABC Ltda", segment: "industrial" },
            { id: 2, name: "Maria Santos", email: "maria@industria.com", phone: "(11) 88888-8888", company: "Ind√∫stria XYZ S.A.", segment: "industrial" },
            { id: 3, name: "Carlos Oliveira", email: "carlos@hospital.com", phone: "(11) 77777-7777", company: "Hospital Central", segment: "hospital" },
            { id: 4, name: "Ana Costa", email: "ana@datacenter.com", phone: "(11) 66666-6666", company: "Data Center Solutions", segment: "data-center" }
        ],
        salespeople: [
            { id: 1, name: "Jo√£o Silva" },
            { id: 2, name: "Maria Santos" },
            { id: 3, name: "Carlos Oliveira" },
            { id: 4, name: "Ana Costa" }
        ],
        products: [
            { id: 1, code: "PN-001", description: "Produto A", price: 100.00, category: "Eletr√¥nicos" },
            { id: 2, code: "PN-002", description: "Produto B", price: 250.50, category: "Mec√¢nica" },
            { id: 3, code: "PN-003", description: "Produto C", price: 75.00, category: "Software" },
            { id: 4, code: "PN-004", description: "Produto D", price: 500.00, category: "Servi√ßos" }
        ],
        offers: [
            { 
                id: 1, 
                customerId: 1, 
                salespersonId: 1, 
                date: "2023-10-15", 
                reminderDate: "2023-11-15",
                closingDate: "2023-12-15", // NEW FIELD
                status: "quoted", 
                chance: 80, 
                market: "industrial",
                products: [
                    { productId: 1, quantity: 10, unitPrice: 100.00 },
                    { productId: 2, quantity: 5, unitPrice: 250.50 }
                ],
                comments: "Cliente interessado no produto A",
                visits: 2,
                revisedQuotes: 1,
                heatmap: 8,
                funnelStage: "stage-qualification",
                attachment: null, // NEW FIELD for file attachment
                lossReason: "" // NEW FIELD for reason of loss
            },
            { 
                id: 2, 
                customerId: 2, 
                salespersonId: 2, 
                date: "2023-10-18", 
                reminderDate: "2023-10-25",
                closingDate: "2023-11-30", // NEW FIELD
                status: "delayed", 
                chance: 50, 
                market: "industrial",
                products: [
                    { productId: 3, quantity: 20, unitPrice: 75.00 }
                ],
                comments: "Aguardando resposta do cliente",
                visits: 1,
                revisedQuotes: 0,
                heatmap: 5,
                funnelStage: "stage-interest",
                attachment: null,
                lossReason: ""
            },
            { 
                id: 3, 
                customerId: 3, 
                salespersonId: 3, 
                date: "2023-10-20", 
                reminderDate: "2023-11-20",
                closingDate: "2023-12-10", // NEW FIELD
                status: "offered", 
                chance: 90, 
                market: "hospital",
                products: [
                    { productId: 4, quantity: 2, unitPrice: 500.00 },
                    { productId: 1, quantity: 5, unitPrice: 100.00 }
                ],
                comments: "Cliente muito satisfeito com a proposta",
                visits: 3,
                revisedQuotes: 2,
                heatmap: 9,
                funnelStage: "stage-proposal",
                attachment: null,
                lossReason: ""
            },
            { 
                id: 4, 
                customerId: 4, 
                salespersonId: 4, 
                date: "2023-10-22", 
                reminderDate: "2023-10-30",
                closingDate: "2023-11-15", // NEW FIELD
                status: "lost", 
                chance: 30, 
                market: "data-center",
                products: [
                    { productId: 2, quantity: 8, unitPrice: 250.50 }
                ],
                comments: "Proposta expirada, tentar recontatar",
                visits: 1,
                revisedQuotes: 1,
                heatmap: 3,
                funnelStage: "stage-negotiation",
                attachment: null,
                lossReason: "price" // NEW FIELD with example value
            }
        ],
        users: [
            { id: 1, name: "Admin User", email: "admin@crm.com", role: "Administrador", active: true },
            { id: 2, name: "Jo√£o Silva", email: "joao@crm.com", role: "Vendedor", active: true },
            { id: 3, name: "Maria Santos", email: "maria@crm.com", role: "Vendedor", active: true }
        ]
    };




        let exportFormat = 'csv';
        let importFormat = 'csv';
    
    // Initialize data
    function initializeData() {
        if (!localStorage.getItem('crmData')) {
            localStorage.setItem('crmData', JSON.stringify(sampleData));
        }
        return JSON.parse(localStorage.getItem('crmData'));
    }

    // Save data to localStorage
    function saveData(data) {
        localStorage.setItem('crmData', JSON.stringify(data));
    }

    // Get data from localStorage
    function getData() {
        return JSON.parse(localStorage.getItem('crmData'));
    }

    // Calculate heatmap value
    function calculateHeatmap(offer) {
        const today = new Date();
        const closingDate = offer.closingDate ? new Date(offer.closingDate) : null;
        
        // Proximity to closing date (0‚Äì10)
        let dateScore = 1;
        if (closingDate) {
            const daysDiff = Math.ceil((closingDate - today) / (1000 * 60 * 60 * 24));
            if (daysDiff <= 3) dateScore = 10;
            else if (daysDiff <= 7) dateScore = 7;
            else if (daysDiff <= 15) dateScore = 4;
            else if (daysDiff <= 30) dateScore = 2;
        }

        // Normalize other metrics (assume max = 10 visits, 5 calls, etc.)
        const visitScore = Math.min(10, (offer.visits || 0) * 2);
        const callScore = Math.min(10, (offer.calls || 0) * 2);
        const revisionScore = Math.min(10, (offer.revisedQuotes || 0) * 2);

        const total = 
            0.30 * dateScore + // Increased weight for closing date
            0.15 * visitScore +
            0.15 * callScore +
            0.15 * revisionScore +
            0.25 * (offer.chance / 10); // Using chance percentage

        return Math.round(Math.max(1, Math.min(10, total)));
    }

    // Calculate total value of an offer
    function calculateTotalValue(products) {
        return products.reduce((total, item) => {
            return total + (item.quantity * item.unitPrice);
        }, 0);
    }

    // Format currency
    function formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);
    }

    // Format date
    function formatDate(dateString) {
        const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
        return new Date(dateString).toLocaleDateString('pt-BR', options);
    }

    // Get status display text and class
    function getStatusInfo(status) {
        switch(status) {
            case 'offered':
                return { text: 'Ofertado', class: 'status-offered' };
            case 'quoted':
                return { text: 'Cotado', class: 'status-quoted' };
            case 'negotiating':
                return { text: 'Negociando', class: 'status-offered' };
            case 'won':
                return { text: 'Ganho', class: 'status-won' };
            case 'lost':
                return { text: 'Perdido', class: 'status-lost' };
            case 'delayed':
                return { text: 'Atrasado', class: 'status-delayed' };
            case 'expired':
                return { text: 'Expirado', class: 'status-expired' };
            default:
                return { text: 'Desconhecido', class: 'status-offered' };
        }
    }

    // Get priority class based on heatmap score
    function getPriorityClass(heatmap) {
        if (heatmap >= 8) return 'high-priority';
        if (heatmap >= 5) return 'medium-priority';
        return 'low-priority';
    }

    // Enhanced Sales Funnel Functions
    function initializeEnhancedFunnel() {
        const data = getData();
        const offers = data.offers || [];
        
        // Clear all stages first
        const stages = ['stage-qualification', 'stage-interest', 'stage-proposal', 'stage-negotiation', 'stage-closing'];
        stages.forEach(stageId => {
            const stageElement = document.getElementById(stageId);
            stageElement.innerHTML = '';
        });

        // Add offers to their respective stages
        offers.forEach(offer => {
            if (!offer.funnelStage) {
                // Auto-assign stage based on heatmap if not set
                offer.funnelStage = autoAssignFunnelStage(offer);
            }
            addOfferToFunnelStage(offer, offer.funnelStage);
        });

        // Update counts and visualization
        updateFunnelStageCounts();
        updateFunnelVisualization();
        updateFunnelStatistics();
        setupFunnelDragAndDrop();
        setupFunnelBarClicks();
    }


function setupFunnelBarClicks() {
        document.querySelectorAll('.funnel-bar').forEach(bar => {
            bar.addEventListener('click', function() {
                const stage = this.getAttribute('data-stage');
                // Navigate to the corresponding stage in the funnel
                const stageElement = document.getElementById(`stage-${getStageId(stage)}`);
                if (stageElement) {
                    // Scroll to the stage
                    stageElement.scrollIntoView({ behavior: 'smooth' });
                    
                    // Highlight the stage briefly
                    stageElement.style.backgroundColor = 'rgba(74, 144, 226, 0.2)';
                    setTimeout(() => {
                        stageElement.style.backgroundColor = '';
                    }, 2000);
                }
            });
        });
    }


function getStageId(stageName) {
        const stageMap = {
            'Qualifica√ß√£o': 'qualification',
            'Interesse': 'interest',
            'Proposta': 'proposal',
            'Negocia√ß√£o': 'negotiation',
            'Fechamento': 'closing'
        };
        return stageMap[stageName] || 'qualification';
    }









    function autoAssignFunnelStage(offer) {
        // Auto-assign stage based on heatmap score
        if (offer.heatmap >= 8) return 'stage-proposal';
        if (offer.heatmap >= 6) return 'stage-negotiation';
        if (offer.heatmap >= 4) return 'stage-interest';
        return 'stage-qualification';
    }

    function addOfferToFunnelStage(offer, stageId) {
        const stageElement = document.getElementById(stageId);
        const data = getData();
        const customer = data.customers.find(c => c.id === offer.customerId);
        
        if (!customer) return;

        // Remove empty state if it exists
        const emptyState = stageElement.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }

        // Create offer card
        const offerCard = document.createElement('div');
        offerCard.className = `funnel-item ${getPriorityClass(offer.heatmap)}`;
        offerCard.setAttribute('draggable', 'true');
        offerCard.setAttribute('data-id', offer.id);
        
        const totalValue = calculateTotalValue(offer.products);
        
        offerCard.innerHTML = `
            <div class="customer-name">${customer.company}</div>
            <div class="customer-company">${customer.name}</div>
            <div class="funnel-item-details">
                <div class="heatmap-indicator-funnel">
                    <div class="heatmap-dot heatmap-${offer.heatmap}"></div>
                    <span>${offer.heatmap}/10</span>
                </div>
                <div class="item-value">${formatCurrency(totalValue)}</div>
            </div>
        `;

        stageElement.appendChild(offerCard);
    }

    function updateFunnelStageCounts() {
        const stages = ['stage-qualification', 'stage-interest', 'stage-proposal', 'stage-negotiation', 'stage-closing'];
        
        stages.forEach(stageId => {
            const stageElement = document.getElementById(stageId);
            const count = stageElement.querySelectorAll('.funnel-item').length;
            const countElement = stageElement.parentElement.querySelector('.stage-count');
            if (countElement) {
                countElement.textContent = count;
            }
        });
    }

    function updateFunnelVisualization() {
        const stages = ['stage-qualification', 'stage-interest', 'stage-proposal', 'stage-negotiation', 'stage-closing'];
        const maxHeight = 250;
        
        stages.forEach((stageId, index) => {
            const stageElement = document.getElementById(stageId);
            const count = stageElement.querySelectorAll('.funnel-item').length;
            const funnelBars = document.querySelectorAll('.funnel-bar');
            
            if (funnelBars[index]) {
                funnelBars[index].setAttribute('data-count', count);
                
                // Adjust height based on count (with max limit)
                const totalOffers = getData().offers.length;
                const height = totalOffers > 0 ? Math.min(maxHeight, 50 + (count / totalOffers * 200)) : 50;
                funnelBars[index].style.height = `${height}px`;
            }
        });
    }

    function updateFunnelStatistics() {
        const data = getData();
        const offers = data.offers || [];
        
        // Total customers (offers)
        document.getElementById('funnel-total-customers').textContent = offers.length;
        
        // Average heatmap
        const avgHeatmap = offers.length > 0 ? 
            (offers.reduce((sum, offer) => sum + offer.heatmap, 0) / offers.length).toFixed(1) : 0;
        document.getElementById('funnel-avg-heatmap').textContent = avgHeatmap;
        
        // Conversion rate (based on stage-closing)
        const closingCount = document.getElementById('stage-closing').querySelectorAll('.funnel-item').length;
        const conversionRate = offers.length > 0 ? ((closingCount / offers.length) * 100).toFixed(1) : 0;
        document.getElementById('funnel-conversion-rate').textContent = `${conversionRate}%`;
        
        // Total value
        const totalValue = offers.reduce((sum, offer) => sum + calculateTotalValue(offer.products), 0);
        document.getElementById('funnel-total-value').textContent = formatCurrency(totalValue);
    }

 // Setup export/import format selection
        function setupFormatSelection() {
            // Export format selection
            document.querySelectorAll('.export-option[data-format]').forEach(option => {
                option.addEventListener('click', function() {
                    // Update active button
                    document.querySelectorAll('.export-option[data-format]').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Update export format
                    exportFormat = this.getAttribute('data-format');
                    
                    // Update format info
                    const exportInfo = document.getElementById('export-info');
                    switch(exportFormat) {
                        case 'csv':
                            exportInfo.textContent = 'CSV: Ideal para abrir em Excel, Google Sheets ou outros programas de planilha';
                            break;
                        case 'xlsx':
                            exportInfo.textContent = 'Excel: Formato nativo do Microsoft Excel, mant√©m formata√ß√£o e f√≥rmulas';
                            break;
                        case 'json':
                            exportInfo.textContent = 'JSON: Formato estruturado, ideal para backup e transfer√™ncia entre sistemas';
                            break;
                    }
                });
            });
            
            // Import format selection
            document.querySelectorAll('.export-option[data-import-format]').forEach(option => {
                option.addEventListener('click', function() {
                    // Update active button
                    document.querySelectorAll('.export-option[data-import-format]').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Update import format
                    importFormat = this.getAttribute('data-import-format');
                    
                    // Update format info
                    const importInfo = document.getElementById('import-info');
                    switch(importFormat) {
                        case 'csv':
                            importInfo.textContent = 'CSV: Formato de planilha com valores separados por v√≠rgulas';
                            break;
                        case 'xlsx':
                            importInfo.textContent = 'Excel: Formato nativo do Microsoft Excel';
                            break;
                        case 'json':
                            importInfo.textContent = 'JSON: Formato estruturado de dados';
                            break;
                    }
                    
                    // Update file input accept attribute
                    const fileInput = document.getElementById('import-file');
                    switch(importFormat) {
                        case 'csv':
                            fileInput.accept = '.csv';
                            break;
                        case 'xlsx':
                            fileInput.accept = '.xlsx,.xls';
                            break;
                        case 'json':
                            fileInput.accept = '.json';
                            break;
                    }
                });
            });
        }




   

    function setupFunnelDragAndDrop() {
        let draggedOffer = null;

        // Allow drop on all stages
        document.querySelectorAll('.funnel-stage-content').forEach(stage => {
            stage.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });
            
            stage.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });
            
            stage.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                if (draggedOffer) {
                    const offerId = parseInt(draggedOffer.getAttribute('data-id'));
                    const data = getData();
                    const offerIndex = data.offers.findIndex(o => o.id === offerId);
                    
                    if (offerIndex !== -1) {
                        // Update offer's funnel stage
                        data.offers[offerIndex].funnelStage = this.id;
                        saveData(data);
                        
                        // Remove from previous stage and add to new stage
                        draggedOffer.remove();
                        addOfferToFunnelStage(data.offers[offerIndex], this.id);
                        
                        // Update counts and visualization
                        updateFunnelStageCounts();
                        updateFunnelVisualization();
                        updateFunnelStatistics();
                    }
                }
            });
        });

        // Add drag events to offer cards
        document.querySelectorAll('.funnel-item').forEach(item => {
            item.addEventListener('dragstart', function(e) {
                draggedOffer = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', this.getAttribute('data-id'));
            });
            
            item.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                draggedOffer = null;
                
                // Remove drag-over class from all stages
                document.querySelectorAll('.funnel-stage-content').forEach(stage => {
                    stage.classList.remove('drag-over');
                });
            });
        });
    }

    function setupFunnelFilters() {
        document.querySelectorAll('.funnel-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active button
                document.querySelectorAll('.funnel-filter-btn').forEach(b => {
                    b.classList.remove('active');
                });
                this.classList.add('active');
                
                // Apply filter
                const filter = this.getAttribute('data-funnel-filter');
                applyFunnelFilter(filter);
            });
        });
    }

    function applyFunnelFilter(filter) {
        const allOfferCards = document.querySelectorAll('.funnel-item');
        
        allOfferCards.forEach(card => {
            const heatmap = parseInt(card.querySelector('.heatmap-indicator-funnel span').textContent);
            
            if (filter === 'all') {
                card.style.display = 'flex';
            } else if (filter === 'high' && heatmap >= 8) {
                card.style.display = 'flex';
            } else if (filter === 'medium' && heatmap >= 5 && heatmap <= 7) {
                card.style.display = 'flex';
            } else if (filter === 'low' && heatmap <= 4) {
                card.style.display = 'flex';
            } else {
                card.style.display = 'none';
            }
        });
    }


    function autoClassifyFunnelOffers() {
        const data = getData();
        
        data.offers.forEach(offer => {
            if (offer.status === 'won' || offer.status === 'lost') {
                offer.funnelStage = 'stage-closing';
            } else {
                offer.funnelStage = autoAssignFunnelStage(offer);
            }
        });
        
        saveData(data);
        initializeEnhancedFunnel();
        alert('Ofertas classificadas automaticamente com base no mapa de calor!');
    }


// Add sorting functionality to table headers
function setupTableSorting() {
    const table = document.getElementById('offers-table');
    const headers = table.querySelectorAll('th[data-sort]');
    let currentSort = { column: null, direction: 'asc' };

    headers.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.getAttribute('data-sort');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort direction
            let direction = 'asc';
            if (currentSort.column === column) {
                direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            }
            
            // Sort rows
            rows.sort((a, b) => {
                const aValue = getCellValue(a, column);
                const bValue = getCellValue(b, column);
                
                if (direction === 'asc') {
                    return compareValues(aValue, bValue);
                } else {
                    return compareValues(bValue, aValue);
                }
            });
            
            // Remove existing rows
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }
            
            // Add sorted rows
            rows.forEach(row => tbody.appendChild(row));
            
            // Update current sort state
            currentSort = { column, direction };
            
            // Update header visual indicators
            updateSortIndicators(headers, column, direction);
        });
    });
}

// Helper function to get cell value based on column
function getCellValue(row, column) {
    const cells = row.querySelectorAll('td');
    const headerIndex = Array.from(row.parentElement.parentElement.querySelectorAll('th'))
        .findIndex(th => th.getAttribute('data-sort') === column);
    
    if (headerIndex === -1 || !cells[headerIndex]) return '';
    
    const cell = cells[headerIndex];
    
    switch(column) {
        case 'id':
            return parseInt(cell.textContent) || 0;
        case 'value':
            const valueText = cell.textContent.replace(/[^\d,.-]/g, '').replace(',', '.');
            return parseFloat(valueText) || 0;
        case 'date':
            return new Date(cell.textContent.split('/').reverse().join('-'));
        case 'heatmap':
            const heatmapMatch = cell.textContent.match(/(\d+)\/10/);
            return heatmapMatch ? parseInt(heatmapMatch[1]) : 0;
        case 'status':
            return cell.querySelector('.status-badge')?.textContent || '';
        case 'customer':
        case 'salesperson':
        default:
            return cell.textContent.toLowerCase();
    }
}

// Helper function to compare values
function compareValues(a, b) {
    if (a === b) return 0;
    
    if (typeof a === 'number' && typeof b === 'number') {
        return a - b;
    }
    
    if (a instanceof Date && b instanceof Date) {
        return a - b;
    }
    
    return a.toString().localeCompare(b.toString());
}

// Update sort indicators in headers
// Update sort indicators in headers
// Update sort indicators in headers
function updateSortIndicators(headers, currentColumn, direction) {
    headers.forEach(header => {
        const column = header.getAttribute('data-sort');
        const originalText = header.getAttribute('data-original-text') || header.textContent.trim();
        
        // Store original text if not already stored
        if (!header.getAttribute('data-original-text')) {
            header.setAttribute('data-original-text', originalText);
        }
        
        // Clear and reset content
        header.innerHTML = '';
        
        // Add the text content
        const textSpan = document.createElement('span');
        textSpan.textContent = originalText;
        header.appendChild(textSpan);
        
        // Add sort indicator if this is the current sorted column
        if (column === currentColumn) {
            const indicator = document.createElement('span');
            indicator.className = 'sort-indicator';
            indicator.textContent = direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
            indicator.style.marginLeft = '5px';
            indicator.style.fontWeight = 'bold';
            header.appendChild(indicator);
            
            // Add CSS class for styling
            header.classList.add('sort-asc', 'sort-desc');
            if (direction === 'asc') {
                header.classList.add('sort-asc');
                header.classList.remove('sort-desc');
            } else {
                header.classList.add('sort-desc');
                header.classList.remove('sort-asc');
            }
        } else {
            // Remove sort classes if not the current sorted column
            header.classList.remove('sort-asc', 'sort-desc');
        }
    });
}







    // Update dashboard statistics
   function updateDashboardStats() {
        const data = getData();
        const offers = data.offers;
        
        // Total offers
        document.getElementById('total-offers').textContent = offers.length;
        
        // Total value
        const totalValue = offers.reduce((sum, offer) => {
            return sum + calculateTotalValue(offer.products);
        }, 0);
        document.getElementById('total-value').textContent = formatCurrency(totalValue);
        
        // Conversion rate
        const wonOffers = offers.filter(offer => offer.status === 'won').length;
        const conversionRate = offers.length > 0 ? (wonOffers / offers.length * 100).toFixed(1) : 0;
        document.getElementById('conversion-rate').textContent = `${conversionRate}%`;
        
        // Delayed offers
        const today = new Date();
        const delayedOffers = offers.filter(offer => {
            if (!offer.reminderDate) return false;
            const reminder = new Date(offer.reminderDate);
            return reminder < today && offer.status !== 'won' && offer.status !== 'lost';
        }).length;
        document.getElementById('delayed-offers').textContent = delayedOffers;
    }

    // Render offers table with toggle for lost offers
     function renderOffersTable(filter = 'all') {
        const data = getData();
        const offers = data.offers;
        const tbody = document.getElementById('offers-tbody');
        const showLostOffers = document.getElementById('show-lost-offers').checked;
        
        tbody.innerHTML = '';
        
        let filteredOffers = offers;
        
        // Apply filter
        if (filter === 'my') {
            filteredOffers = offers.filter(offer => offer.salespersonId === 1); // Assuming current user ID is 1
        } else if (filter === 'delayed') {
            const today = new Date();
            filteredOffers = offers.filter(offer => {
                if (!offer.reminderDate) return false;
                const reminder = new Date(offer.reminderDate);
                return reminder < today && offer.status !== 'won' && offer.status !== 'lost';
            });
        } else if (filter === 'high-priority') {
            filteredOffers = offers.filter(offer => offer.heatmap >= 8);
        }
        
        // Apply lost offers filter
        if (!showLostOffers) {
            filteredOffers = filteredOffers.filter(offer => offer.status !== 'lost');
        }
        
        // Sort by heatmap (descending)
        filteredOffers.sort((a, b) => b.heatmap - a.heatmap);
        
        // Render offers
        filteredOffers.forEach(offer => {
            const customer = data.customers.find(c => c.id === offer.customerId);
            const salesperson = data.salespeople.find(s => s.id === offer.salespersonId);
            const totalValue = calculateTotalValue(offer.products);
            const statusInfo = getStatusInfo(offer.status);
            const priorityClass = getPriorityClass(offer.heatmap);
            
            // Check if offer is delayed
            const today = new Date();
            const reminderDate = offer.reminderDate ? new Date(offer.reminderDate) : null;
            const isDelayed = reminderDate && reminderDate < today && offer.status !== 'won' && offer.status !== 'lost';
            
            // Check if offer is expired (closing date passed)
            const closingDate = offer.closingDate ? new Date(offer.closingDate) : null;
            const isExpired = closingDate && closingDate < today && offer.status !== 'won' && offer.status !== 'lost';
            
            const row = document.createElement('tr');
            row.className = priorityClass;
            if (isDelayed) row.classList.add('status-delayed-row');
            if (isExpired) row.classList.add('status-expired-row');
            
            row.innerHTML = `
                <td>${offer.id}</td>
                <td>${customer ? customer.company : 'N/A'}</td>
                <td>${salesperson ? salesperson.name : 'N/A'}</td>
                <td>${formatDate(offer.date)}</td>
                <td>${formatCurrency(totalValue)}</td>
                <td>
                    <div class="heatmap-indicator">
                        <div class="heatmap-bar">
                            <div class="heatmap-fill" style="width: ${offer.heatmap * 10}%"></div>
                        </div>
                        <span>${offer.heatmap}/10</span>
                    </div>
                </td>
                <td>
                    <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>
                </td>
                <td>
                    <button class="btn-action edit-offer" data-id="${offer.id}">
                        <i>‚úèÔ∏è</i>
                    </button>
                    <button class="btn-action email-reminder-btn" data-id="${offer.id}">
                        <i>üìß</i>
                    </button>
                    <button class="btn-action delete-offer" data-id="${offer.id}">
                        <i>üóëÔ∏è</i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        // Add event listeners to action buttons
        document.querySelectorAll('.edit-offer').forEach(btn => {
            btn.addEventListener('click', function() {
                const offerId = parseInt(this.getAttribute('data-id'));
                openEditOfferModal(offerId);
            });
        });
        
        document.querySelectorAll('.email-reminder-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const offerId = parseInt(this.getAttribute('data-id'));
                openEmailReminderModal(offerId);
            });
        });
        
        document.querySelectorAll('.delete-offer').forEach(btn => {
            btn.addEventListener('click', function() {
                const offerId = parseInt(this.getAttribute('data-id'));
                deleteOffer(offerId);
            });
        });
    }

    // Open email reminder modal
    function openEmailReminderModal(offerId) {
        const data = getData();
        const offer = data.offers.find(o => o.id === offerId);
        
        if (!offer) return;
        
        const customer = data.customers.find(c => c.id === offer.customerId);
        const salesperson = data.salespeople.find(s => s.id === offer.salespersonId);
        
        if (!customer) return;
        
        // Pre-fill email form
        document.getElementById('email-to').value = customer.email || '';
        document.getElementById('email-subject').value = `Lembrete - Oferta ${offer.id} - ${customer.company}`;
        
        // Create email message template
        const totalValue = calculateTotalValue(offer.products);
        const message = `Prezado(a) ${customer.name},

Gostar√≠amos de lembr√°-lo sobre nossa oferta ${offer.id} para ${customer.company} no valor de ${formatCurrency(totalValue)}.

Status atual: ${getStatusInfo(offer.status).text}
Data prevista de fechamento: ${offer.closingDate ? formatDate(offer.closingDate) : 'N√£o definida'}

${offer.comments ? `Observa√ß√µes: ${offer.comments}` : ''}

Atenciosamente,
${salesperson ? salesperson.name : 'Equipe de Vendas'}`;
        
        document.getElementById('email-message').value = message;
        
        // Set form submit handler
        const form = document.getElementById('email-reminder-form');
        form.onsubmit = function(e) {
            e.preventDefault();
            sendEmailReminder(offerId);
        };
        
        // Show modal
        document.getElementById('email-reminder-modal').style.display = 'block';
    }

    // Send email reminder
    function sendEmailReminder(offerId) {
        const to = document.getElementById('email-to').value;
        const subject = document.getElementById('email-subject').value;
        const message = document.getElementById('email-message').value;
        
        // In a real application, you would send this to your backend
        // For this demo, we'll simulate sending an email
        console.log('Sending email reminder:');
        console.log('To:', to);
        console.log('Subject:', subject);
        console.log('Message:', message);
        
        // Simulate email sending
        setTimeout(() => {
            alert('Lembrete enviado com sucesso!');
            document.getElementById('email-reminder-modal').style.display = 'none';
            
            // Update offer with reminder sent date
            const data = getData();
            const offerIndex = data.offers.findIndex(o => o.id === offerId);
            if (offerIndex !== -1) {
                data.offers[offerIndex].lastReminderSent = new Date().toISOString().split('T')[0];
                saveData(data);
            }
        }, 1000);
    }

    
  function openEditOfferModal(offerId) {
        const data = getData();
        const offer = data.offers.find(o => o.id === offerId);
        
        if (!offer) return;
        
        // Populate form with offer data
        document.getElementById('offer-modal-title').textContent = 'Editar Oferta';
        document.getElementById('offer-customer').value = offer.customerId;
        document.getElementById('offer-salesperson').value = offer.salespersonId;
        document.getElementById('offer-date').value = offer.date;
        document.getElementById('offer-reminder').value = offer.reminderDate || '';
        document.getElementById('offer-closing-date').value = offer.closingDate || ''; // NEW FIELD
        document.getElementById('offer-status').value = offer.status;
        document.getElementById('offer-loss-reason').value = offer.lossReason || ''; // NEW FIELD
        document.getElementById('offer-chance').value = offer.chance;
        document.getElementById('offer-market').value = offer.market;
        document.getElementById('offer-comments').value = offer.comments || '';
        
        // Show/hide loss reason field based on status
        toggleLossReasonField(offer.status);
        
        // Populate products
        const productsContainer = document.getElementById('offer-products');
        productsContainer.innerHTML = '';
        
        offer.products.forEach(product => {
            addProductRow(product.productId, product.quantity, product.unitPrice);
        });
        
        // Show existing attachment if any
        const attachmentDisplay = document.getElementById('attachment-display');
        if (offer.attachment) {
            attachmentDisplay.innerHTML = `
                <div class="existing-attachment">
                    <span>Anexo atual: ${offer.attachment.name}</span>
                    <button type="button" class="btn btn-danger" id="remove-attachment">Remover</button>
                </div>
            `;
            
            document.getElementById('remove-attachment').addEventListener('click', function() {
                // Remove attachment from offer
                offer.attachment = null;
                saveData(data);
                attachmentDisplay.innerHTML = '';
            });
        } else {
            attachmentDisplay.innerHTML = '';
        }
        
        // Set form submit handler for update
        const form = document.getElementById('offer-form');
        
        // Remove any existing event listeners to prevent duplicates
        form.onsubmit = null;
        
        form.onsubmit = function(e) {
            e.preventDefault();
            updateOffer(offerId);
        };
        
        // Show modal
        document.getElementById('offer-modal').style.display = 'block';
    }

// Update offer
   function updateOffer(offerId) {
        const data = getData();
        const offerIndex = data.offers.findIndex(o => o.id === offerId);
        
        if (offerIndex === -1) return;
        
        // Get form values
        const customerId = parseInt(document.getElementById('offer-customer').value);
        const salespersonId = parseInt(document.getElementById('offer-salesperson').value);
        const date = document.getElementById('offer-date').value;
        const reminderDate = document.getElementById('offer-reminder').value;
        const closingDate = document.getElementById('offer-closing-date').value; // NEW FIELD
        const status = document.getElementById('offer-status').value;
        const lossReason = document.getElementById('offer-loss-reason').value; // NEW FIELD
        const chance = parseInt(document.getElementById('offer-chance').value);
        const market = document.getElementById('offer-market').value;
        const comments = document.getElementById('offer-comments').value;
        
        // Get products
        const products = [];
        document.querySelectorAll('.product-row').forEach(row => {
            const productId = parseInt(row.querySelector('.product-select').value);
            const quantity = parseInt(row.querySelector('.product-quantity').value);
            const unitPrice = parseFloat(row.querySelector('.product-price').value);
            
            if (productId && quantity && unitPrice) {
                products.push({
                    productId: productId,
                    quantity: quantity,
                    unitPrice: unitPrice
                });
            }
        });
        
        // Handle file attachment
        const fileInput = document.getElementById('offer-attachment');
        let attachment = data.offers[offerIndex].attachment;
        
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            attachment = {
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: file.lastModified,
                // In a real app, you would upload the file to a server or storage
                // For this demo, we'll just store the file info
            };
        }
        
        // Update offer
        data.offers[offerIndex] = {
            ...data.offers[offerIndex],
            customerId: customerId,
            salespersonId: salespersonId,
            date: date,
            reminderDate: reminderDate,
            closingDate: closingDate, // NEW FIELD
            status: status,
            lossReason: lossReason, // NEW FIELD
            chance: chance,
            market: market,
            products: products,
            comments: comments,
            attachment: attachment,
            heatmap: calculateHeatmap({
                ...data.offers[offerIndex],
                closingDate: closingDate,
                chance: chance
            })
        };
        
        saveData(data);
        
        // Close modal and refresh
        document.getElementById('offer-modal').style.display = 'none';
        renderOffersTable();
        updateDashboardStats();
        initializeEnhancedFunnel();
        renderAllOffersTable();
        alert('Oferta atualizada com sucesso!');
    }


  function deleteOffer(offerId) {
        if (confirm('Tem certeza que deseja excluir esta oferta?')) {
            const data = getData();
            data.offers = data.offers.filter(o => o.id !== offerId);
            saveData(data);
            
            renderOffersTable();
            updateDashboardStats();
            initializeEnhancedFunnel();
            
            alert('Oferta exclu√≠da com sucesso!');
        }
    }
    // Toggle loss reason field based on status
    function toggleLossReasonField(status) {
        const lossReasonGroup = document.getElementById('loss-reason-group');
        if (status === 'lost') {
            lossReasonGroup.style.display = 'block';
        } else {
            lossReasonGroup.style.display = 'none';
        }
    }






    // Render customers table
    function renderCustomersTable() {
        const data = getData();
        const tbody = document.getElementById('customers-tbody');
        tbody.innerHTML = '';
        
        data.customers.forEach(customer => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${customer.name}</td>
                <td>${customer.email}</td>
                <td>${customer.phone}</td>
                <td>${customer.company}</td>
                <td>${customer.segment}</td>
                <td class="action-buttons">
                    <button class="action-btn edit-customer" data-id="${customer.id}">Editar</button>
                    <button class="action-btn delete-customer" data-id="${customer.id}">Excluir</button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Add event listeners
        document.querySelectorAll('.edit-customer').forEach(btn => {
            btn.addEventListener('click', function() {
                const customerId = parseInt(this.getAttribute('data-id'));
                openCustomerModal(customerId);
            });
        });
        
        document.querySelectorAll('.delete-customer').forEach(btn => {
            btn.addEventListener('click', function() {
                const customerId = parseInt(this.getAttribute('data-id'));
                deleteCustomer(customerId);
            });
        });
    }

    // Render all offers table
    function renderAllOffersTable() {
        const data = getData();
        const tbody = document.getElementById('all-offers-tbody');
        tbody.innerHTML = '';
        
        data.offers.forEach(offer => {
            const customer = data.customers.find(c => c.id === offer.customerId);
            const salesperson = data.salespeople.find(s => s.id === offer.salespersonId);
            const statusInfo = getStatusInfo(offer.status);
            const totalValue = calculateTotalValue(offer.products);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>OP-${offer.id.toString().padStart(3, '0')}</td>
                <td>${customer ? customer.company : 'Cliente n√£o encontrado'}</td>
                <td>${salesperson ? salesperson.name : 'Vendedor n√£o encontrado'}</td>
                <td>${formatDate(offer.date)}</td>
                <td>${formatCurrency(totalValue)}</td>
                <td><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></td>
                <td class="action-buttons">
                    <button class="action-btn edit-offer" data-id="${offer.id}">Editar</button>
                    <button class="action-btn export-offer" data-id="${offer.id}">Exportar</button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Add event listeners to action buttons
        document.querySelectorAll('.edit-offer').forEach(btn => {
            btn.addEventListener('click', function() {
                const offerId = parseInt(this.getAttribute('data-id'));
                openOfferModal(offerId);
            });
        });
        
        document.querySelectorAll('.export-offer').forEach(btn => {
            btn.addEventListener('click', function() {
                const offerId = parseInt(this.getAttribute('data-id'));
                exportOffer(offerId);
            });
        });
    }

    // Render sales funnel
    function renderSalesFunnel() {
        initializeEnhancedFunnel();
        setupFunnelFilters();
        
        // Add event listener for auto-classify button
        document.getElementById('auto-classify-btn').addEventListener('click', autoClassifyFunnelOffers);
    }

    // Open offer modal for creating or editing
   // Open offer modal for creating or editing (CORRIGIDA)
// Open offer modal for creating or editing (CORRECTED)
function openOfferModal(offerId = null) {
    const modal = document.getElementById('offer-modal');
    const title = document.getElementById('offer-modal-title');
    const form = document.getElementById('offer-form');
    const data = getData();
    
    // Verificar se os elementos essenciais existem
    if (!modal || !title || !form) {
        console.error('Elementos do modal n√£o encontrados');
        return;
    }
    
    // Reset form
    form.reset();
    
    // Populate dropdowns apenas se os elementos existirem
    const customerDropdown = document.getElementById('offer-customer');
    const salespersonDropdown = document.getElementById('offer-salesperson');
    
    if (customerDropdown) {
        populateDropdown(customerDropdown, data.customers, 'id', 'company');
    }
    
    if (salespersonDropdown) {
        populateDropdown(salespersonDropdown, data.salespeople, 'id', 'name');
    }
    
    // Clear existing products and add one empty row
    const productsContainer = document.getElementById('offer-products');
    if (productsContainer) {
        productsContainer.innerHTML = '';
        addProductRow();
    }
    
    if (offerId) {
        // Edit existing offer
        title.textContent = 'Editar Oferta';
        const offer = data.offers.find(o => o.id === offerId);
        
        if (offer) {
            if (customerDropdown) customerDropdown.value = offer.customerId;
            if (salespersonDropdown) salespersonDropdown.value = offer.salespersonId;
            
            document.getElementById('offer-date').value = offer.date;
            document.getElementById('offer-reminder').value = offer.reminderDate || '';
            document.getElementById('offer-closing-date').value = offer.closingDate || '';
            document.getElementById('offer-status').value = offer.status;
            document.getElementById('offer-loss-reason').value = offer.lossReason || '';
            document.getElementById('offer-chance').value = offer.chance;
            document.getElementById('offer-market').value = offer.market;
            document.getElementById('offer-comments').value = offer.comments || '';
            
            // Show/hide loss reason field based on status
            toggleLossReasonField(offer.status);
            
            // Clear and repopulate products
            if (productsContainer) {
                productsContainer.innerHTML = '';
                offer.products.forEach(product => {
                    addProductRow(product.productId, product.quantity, product.unitPrice);
                });
            }
        }
        
        // Store offer ID for update
        form.setAttribute('data-offer-id', offerId);
    } else {
        // Create new offer
        title.textContent = 'Nova Oferta';
        form.removeAttribute('data-offer-id');
    }
    
    modal.style.display = 'flex';
}


    // Add product row to offer form

function addProductRow(productId = '', quantity = '', price = '') {
    const productsContainer = document.getElementById('offer-products');
    const data = getData();
    
    if (!productsContainer) {
        console.error('Container de produtos n√£o encontrado');
        return;
    }
    
    const rowId = 'product-row-' + Date.now();
    
    const row = document.createElement('div');
    row.className = 'product-row form-row';
    row.innerHTML = `
        <div class="form-col">
            <select class="form-control product-select" id="${rowId}-select">
                <option value="">Selecione um produto</option>
                ${data.products.map(p => 
                    `<option value="${p.id}" ${p.id == productId ? 'selected' : ''}>${p.code} - ${p.description}</option>`
                ).join('')}
            </select>
        </div>
        <div class="form-col">
            <input type="number" class="form-control product-quantity" placeholder="Quantidade" min="1" value="${quantity}">
        </div>
        <div class="form-col">
            <input type="number" class="form-control product-price" placeholder="Pre√ßo Unit√°rio" step="0.01" min="0" value="${price}">
        </div>
        <div class="form-col">
            <button type="button" class="btn btn-danger remove-product">Remover</button>
        </div>
    `;
    
    productsContainer.appendChild(row);
    
    // Add event listener to remove button
    row.querySelector('.remove-product').addEventListener('click', function() {
        if (document.querySelectorAll('.product-row').length > 1) {
            row.remove();
        } else {
            alert('Uma oferta deve ter pelo menos um produto.');
        }
    });
}

    // Populate dropdown with options
    // Populate dropdown with options (CORRIGIDA)
function populateDropdown(dropdownId, options, valueField, textField, includeAll = false) {
    let dropdown;
    
    // Handle both string ID and DOM element
    if (typeof dropdownId === 'string') {
        dropdown = document.getElementById(dropdownId);
    } else {
        dropdown = dropdownId;
    }
    
    // Verificar se o elemento existe
    if (!dropdown) {
        console.warn(`Elemento com ID '${dropdownId}' n√£o encontrado`);
        return;
    }
    
    // Save current selection if editing
    const currentValue = dropdown.value;
    
    dropdown.innerHTML = '';
    
    if (includeAll) {
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Selecione um produto';
        dropdown.appendChild(defaultOption);
    }
    
    options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option[valueField];
        optionElement.textContent = option[textField];
        dropdown.appendChild(optionElement);
    });
    
    // Restore selection if it still exists
    if (currentValue && dropdown.querySelector(`option[value="${currentValue}"]`)) {
        dropdown.value = currentValue;
    }
}
    // Open customer modal for creating or editing
    function openCustomerModal(customerId = null) {
        const modal = document.getElementById('customer-modal');
        const title = document.getElementById('customer-modal-title');
        const form = document.getElementById('customer-form');
        const data = getData();
        
        // Reset form
        form.reset();
        
        if (customerId) {
            // Edit existing customer
            title.textContent = 'Editar Cliente';
            const customer = data.customers.find(c => c.id === customerId);
            
            if (customer) {
                document.getElementById('customer-name').value = customer.name;
                document.getElementById('customer-email').value = customer.email;
                document.getElementById('customer-phone').value = customer.phone;
                document.getElementById('customer-company').value = customer.company;
                document.getElementById('customer-segment').value = customer.segment;
            }
            
            // Store customer ID for update
            form.setAttribute('data-customer-id', customerId);
        } else {
            // Create new customer
            title.textContent = 'Novo Cliente';
            form.removeAttribute('data-customer-id');
        }
        
        modal.style.display = 'flex';
    }

    // Delete customer
    function deleteCustomer(customerId) {
        if (confirm('Tem certeza que deseja excluir este cliente?')) {
            const data = getData();
            
            // Check if customer has offers
            const hasOffers = data.offers.some(offer => offer.customerId === customerId);
            if (hasOffers) {
                alert('N√£o √© poss√≠vel excluir este cliente porque existem ofertas associadas a ele.');
                return;
            }
            
            // Remove customer
            data.customers = data.customers.filter(c => c.id !== customerId);
            saveData(data);
            renderCustomersTable();
        }
    }

    // Export offer to PDF (simulated)
    function exportOffer(offerId) {
        const data = getData();
        const offer = data.offers.find(o => o.id === offerId);
        const customer = data.customers.find(c => c.id === offer.customerId);
        const salesperson = data.salespeople.find(s => s.id === offer.salespersonId);
        
        if (!offer || !customer || !salesperson) {
            alert('Dados da oferta n√£o encontrados.');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const totalValue = calculateTotalValue(offer.products);

        doc.setFontSize(20);
        doc.text("COTA√á√ÉO COMERCIAL", 105, 20, null, null, "center");
        doc.setFillColor(30, 30, 30);
        doc.rect(0, 25, 210, 8, 'F');

        doc.setFontSize(12);
        doc.text(`Cliente: ${customer.company}`, 14, 40);
        doc.text(`Vendedor: ${salesperson.name}`, 14, 46);
        doc.text(`Valor Total: ${formatCurrency(totalValue)}`, 14, 52);
        doc.text(`Status: ${getStatusInfo(offer.status).text}`, 14, 58);
        doc.text(`Heat Score: ${offer.heatmap}/10`, 14, 64);

        doc.save(`Cotacao_${offerId}.pdf`);
    }

    // Save offer (create or update)
    function saveOffer() {
        const form = document.getElementById('offer-form');
        const data = getData();
        
        // Get form values
        const customerId = parseInt(document.getElementById('offer-customer').value);
        const salespersonId = parseInt(document.getElementById('offer-salesperson').value);
        const date = document.getElementById('offer-date').value;
        const reminderDate = document.getElementById('offer-reminder').value;
        const status = document.getElementById('offer-status').value;
        const chance = parseInt(document.getElementById('offer-chance').value);
        const market = document.getElementById('offer-market').value;
        const comments = document.getElementById('offer-comments').value;
        
        // Get products
        const products = [];
        document.querySelectorAll('.product-row').forEach(row => {
            const productId = parseInt(row.querySelector('.product-select').value);
            const quantity = parseInt(row.querySelector('.product-quantity').value);
            const unitPrice = parseFloat(row.querySelector('.product-price').value);
            
            if (productId && quantity && unitPrice) {
                products.push({
                    productId: productId,
                    quantity: quantity,
                    unitPrice: unitPrice
                });
            }
        });
        
        if (products.length === 0) {
            alert('Por favor, adicione pelo menos um produto √† oferta.');
            return;
        }
        
        const offerId = form.getAttribute('data-offer-id');
        
        if (offerId) {
            // Update existing offer
            const offerIndex = data.offers.findIndex(o => o.id === parseInt(offerId));
            if (offerIndex !== -1) {
                data.offers[offerIndex] = {
                    ...data.offers[offerIndex],
                    customerId,
                    salespersonId,
                    date,
                    reminderDate,
                    status,
                    chance,
                    market,
                    products,
                    comments,
                    heatmap: calculateHeatmap({ chance, visits: data.offers[offerIndex].visits || 0, revisedQuotes: data.offers[offerIndex].revisedQuotes || 0, reminderDate })
                };
            }
        } else {
            // Create new offer
            const newId = data.offers.length > 0 ? Math.max(...data.offers.map(o => o.id)) + 1 : 1;
            
            data.offers.push({
                id: newId,
                customerId,
                salespersonId,
                date,
                reminderDate,
                status,
                chance,
                market,
                products,
                comments,
                visits: 0,
                revisedQuotes: 0,
                heatmap: calculateHeatmap({ chance, visits: 0, revisedQuotes: 0, reminderDate })
            });
        }
        
        saveData(data);
        document.getElementById('offer-modal').style.display = 'none';
        
        // Refresh displays
        updateDashboardStats();
        renderOffersTable();
        renderAllOffersTable();
        renderSalesFunnel();
    }

    // Save customer (create or update)
    function saveCustomer() {
        const form = document.getElementById('customer-form');
        const data = getData();
        
        // Get form values
        const name = document.getElementById('customer-name').value;
        const email = document.getElementById('customer-email').value;
        const phone = document.getElementById('customer-phone').value;
        const company = document.getElementById('customer-company').value;
        const segment = document.getElementById('customer-segment').value;
        
        const customerId = form.getAttribute('data-customer-id');
        
        if (customerId) {
            // Update existing customer
            const customerIndex = data.customers.findIndex(c => c.id === parseInt(customerId));
            if (customerIndex !== -1) {
                data.customers[customerIndex] = {
                    ...data.customers[customerIndex],
                    name,
                    email,
                    phone,
                    company,
                    segment
                };
            }
        } else {
            // Create new customer
            const newId = data.customers.length > 0 ? Math.max(...data.customers.map(c => c.id)) + 1 : 1;
            
            data.customers.push({
                id: newId,
                name,
                email,
                phone,
                company,
                segment
            });
        }
        
        saveData(data);
        document.getElementById('customer-modal').style.display = 'none';
        renderCustomersTable();
        
        // Also update customer dropdown in offer form
        populateDropdown('offer-customer', data.customers, 'id', 'company');
    }

    // Export all data
function exportAllData() {
            const data = getData();
            
            switch(exportFormat) {
                case 'csv':
                    exportDataAsCSV(data);
                    break;
                case 'xlsx':
                    exportDataAsXLSX(data);
                    break;
                case 'json':
                    exportDataAsJSON(data);
                    break;
            }
        }


// Export data as CSV
        function exportDataAsCSV(data) {
            // Create CSV content for each data type
            const csvContent = {
                customers: convertToCSV(data.customers, ['id', 'name', 'email', 'phone', 'company', 'segment']),
                salespeople: convertToCSV(data.salespeople, ['id', 'name']),
                products: convertToCSV(data.products, ['id', 'code', 'description', 'price', 'category', 'notes']),
                offers: convertOffersToCSV(data.offers),
                users: convertToCSV(data.users, ['id', 'name', 'email', 'role', 'phone', 'department', 'notes', 'active'])
            };
            
            // Create a zip file with all CSV files
            const zip = new JSZip();
            
            // Add each CSV to the zip
            for (const [key, content] of Object.entries(csvContent)) {
                if (content) {
                    zip.file(`${key}.csv`, content);
                }
            }
            
            // Generate and download the zip file
            zip.generateAsync({type: "blob"})
                .then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = 'crm-data-export.zip';
                    link.click();
                });
        }

        // Export data as XLSX
        function exportDataAsXLSX(data) {
            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // Add worksheets for each data type
            XLSX.utils.book_append_sheet(wb, 
                XLSX.utils.json_to_sheet(data.customers), 
                'Customers');
            XLSX.utils.book_append_sheet(wb, 
                XLSX.utils.json_to_sheet(data.salespeople), 
                'Salespeople');
            XLSX.utils.book_append_sheet(wb, 
                XLSX.utils.json_to_sheet(data.products), 
                'Products');
            XLSX.utils.book_append_sheet(wb, 
                XLSX.utils.json_to_sheet(flattenOffers(data.offers)), 
                'Offers');
            XLSX.utils.book_append_sheet(wb, 
                XLSX.utils.json_to_sheet(data.users), 
                'Users');
            
            // Generate and download the file
            XLSX.writeFile(wb, 'crm-data-export.xlsx');
        }


 // Export data as JSON (original functionality)
        function exportDataAsJSON(data) {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            // Create download link
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'crm-data-backup.json';
            link.click();
        }

        // Helper function to convert array of objects to CSV
        function convertToCSV(data, fields) {
            if (!data || data.length === 0) return '';
            
            // Create header row
            let csv = fields.join(',') + '\n';
            
            // Add data rows
            data.forEach(item => {
                const row = fields.map(field => {
                    let value = item[field] || '';
                    
                    // Handle special cases
                    if (typeof value === 'string' && value.includes(',')) {
                        value = `"${value}"`; // Quote values with commas
                    }
                    
                    return value;
                });
                
                csv += row.join(',') + '\n';
            });
            
            return csv;
        }

        // Special function to convert offers to CSV (handles nested products array)
        function convertOffersToCSV(offers) {
            if (!offers || offers.length === 0) return '';
            
            // Define fields for offers
            const fields = [
                'id', 'customerId', 'salespersonId', 'date', 'reminderDate', 
                'closingDate', 'status', 'lossReason', 'chance', 'market', 
                'comments', 'visits', 'revisedQuotes', 'heatmap', 'funnelStage'
            ];
            
            // Create header row
            let csv = fields.join(',') + ',products\n';
            
            // Add data rows
            offers.forEach(offer => {
                const row = fields.map(field => {
                    let value = offer[field] || '';
                    
                    // Handle special cases
                    if (typeof value === 'string' && value.includes(',')) {
                        value = `"${value}"`; // Quote values with commas
                    }
                    
                    return value;
                });
                
                // Handle products array
                const products = offer.products || [];
                const productsStr = products.map(p => 
                    `${p.productId}:${p.quantity}:${p.unitPrice}`
                ).join(';');
                
                row.push(productsStr);
                
                csv += row.join(',') + '\n';
            });
            
            return csv;
        }

        // Helper function to flatten offers for XLSX export
        function flattenOffers(offers) {
            return offers.map(offer => {
                const flatOffer = {...offer};
                
                // Convert products array to string
                if (offer.products && offer.products.length > 0) {
                    flatOffer.products = offer.products.map(p => 
                        `${p.productId}:${p.quantity}:${p.unitPrice}`
                    ).join('; ');
                }
                
                return flatOffer;
            });
        }

        // Import data in selected format
        // Import data in selected format
function importData() {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Por favor, selecione um arquivo para importar.');
        return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            let importedData;
            
            switch(importFormat) {
                case 'csv':
                    importedData = parseCSVImport(e.target.result, file.name);
                    break;
                case 'xlsx':
                    importedData = parseXLSXImport(e.target.result);
                    break;
                case 'json':
                    importedData = JSON.parse(e.target.result);
                    break;
            }
            
            if (importedData && validateImportedData(importedData)) {
                saveData(importedData);
                alert('Dados importados com sucesso!');
                document.getElementById('import-area').style.display = 'none';
                fileInput.value = '';
                
                // Refresh all displays
                initApp();
            } else {
                alert('Erro ao processar os dados importados. Estrutura de dados inv√°lida.');
            }
        } catch (error) {
            console.error('Import error:', error);
            alert('Erro ao importar dados. O arquivo pode estar corrompido ou em formato inv√°lido.');
        }
    };
    
    // Read the file based on format
    switch(importFormat) {
        case 'csv':
            // For CSV, we need to handle ZIP files
            if (file.name.endsWith('.zip')) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
            break;
        case 'xlsx':
            reader.readAsArrayBuffer(file);
            break;
        case 'json':
            reader.readAsText(file);
            break;
    }
}

// Process individual CSV file from ZIP
function processCSVFile(filename, content, data) {
    const lines = content.split('\n').filter(line => line.trim() !== '');
    if (lines.length < 2) return;
    
    const headers = lines[0].split(',').map(h => h.trim());
    
    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        const item = {};
        
        headers.forEach((header, index) => {
            if (values[index] !== undefined) {
                let value = values[index];
                
                // Parse numbers and booleans
                if (!isNaN(value) && value !== '') {
                    value = Number(value);
                } else if (value === 'true') {
                    value = true;
                } else if (value === 'false') {
                    value = false;
                }
                
                item[header] = value;
            }
        });
        
        // Add to appropriate array based on filename
        if (filename.includes('customers')) {
            data.customers.push(item);
        } else if (filename.includes('salespeople')) {
            data.salespeople.push(item);
        } else if (filename.includes('products')) {
            data.products.push(item);
        } else if (filename.includes('offers')) {
            // Process offers specially to handle products array
            if (item.products) {
                item.products = parseProductsString(item.products);
            }
            data.offers.push(item);
        } else if (filename.includes('users')) {
            data.users.push(item);
        }
    }
}


// Parse CSV line handling quoted values and commas within quotes
function parseCSVLine(line) {
    const values = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            values.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    
    values.push(current);
    return values.map(v => v.trim().replace(/^"|"$/g, ''));
}

// Parse products string from CSV (format: "productId:quantity:unitPrice;productId:quantity:unitPrice")
function parseProductsString(productsStr) {
    if (!productsStr) return [];
    
    return productsStr.split(';').map(productStr => {
        const parts = productStr.split(':');
        if (parts.length === 3) {
            return {
                productId: parseInt(parts[0]),
                quantity: parseInt(parts[1]),
                unitPrice: parseFloat(parts[2])
            };
        }
        return null;
    }).filter(product => product !== null);
}



// Parse XLSX import
function parseXLSXImport(arrayBuffer) {
    try {
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const data = {
            customers: [],
            salespeople: [],
            products: [],
            offers: [],
            users: []
        };
        
        // Extract data from each worksheet
        workbook.SheetNames.forEach(sheetName => {
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            // Map sheet names to data properties
            const propertyMap = {
                'Customers': 'customers',
                'Salespeople': 'salespeople',
                'Products': 'products',
                'Offers': 'offers',
                'Users': 'users'
            };
            
            const propertyName = propertyMap[sheetName];
            if (propertyName && jsonData.length > 0) {
                data[propertyName] = jsonData;
            }
        });
        
        // Process offers to convert product strings back to arrays
        if (data.offers) {
            data.offers = data.offers.map(offer => {
                if (typeof offer.products === 'string') {
                    offer.products = parseProductsString(offer.products);
                }
                return offer;
            });
        }
        
        return data;
    } catch (error) {
        console.error('Error parsing XLSX:', error);
        return null;
    }
}


// Validate imported data structure
function validateImportedData(data) {
    const requiredArrays = ['customers', 'salespeople', 'products', 'offers', 'users'];
    
    for (const arrayName of requiredArrays) {
        if (!Array.isArray(data[arrayName])) {
            console.error(`Missing or invalid array: ${arrayName}`);
            return false;
        }
    }
    
    return true;
}

// Create basic data structure for single file imports
function createBasicDataStructure() {
    return {
        customers: [],
        salespeople: [],
        products: [],
        offers: [],
        users: []
    };
}



// Parse ZIP file containing multiple CSV files
function parseCSVZipImport(arrayBuffer) {
    return new Promise((resolve, reject) => {
        JSZip.loadAsync(arrayBuffer)
            .then(function(zip) {
                const data = {
                    customers: [],
                    salespeople: [],
                    products: [],
                    offers: [],
                    users: []
                };
                
                const promises = [];
                
                // Process each CSV file in the ZIP
                Object.keys(zip.files).forEach(function(filename) {
                    const file = zip.files[filename];
                    if (!file.dir) {
                        promises.push(
                            file.async('string').then(function(content) {
                                processCSVFile(filename, content, data);
                            })
                        );
                    }
                });
                
                Promise.all(promises).then(function() {
                    resolve(data);
                }).catch(reject);
            })
            .catch(reject);
    });
}





      function parseCSVImport(data, fileName) {
    // If it's a ZIP file
    if (fileName.endsWith('.zip')) {
        return parseCSVZipImport(data);
    } else {
        // Single CSV file - try to parse as the main data structure
        try {
            return JSON.parse(data);
        } catch (e) {
            // If not JSON, create basic structure with the CSV data
            console.warn('Single CSV import - creating basic structure');
            return createBasicDataStructure();
        }
    }
}


        // Parse XLSX data and convert to structured format
        function parseXLSXData(arrayBuffer) {
            try {
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const data = {};
                
                // Extract data from each worksheet
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // Map sheet names to data properties
                    const propertyMap = {
                        'Customers': 'customers',
                        'Salespeople': 'salespeople',
                        'Products': 'products',
                        'Offers': 'offers',
                        'Users': 'users'
                    };
                    
                    const propertyName = propertyMap[sheetName];
                    if (propertyName) {
                        data[propertyName] = jsonData;
                    }
                });
                
                // Process offers to convert product strings back to arrays
                if (data.offers) {
                    data.offers = data.offers.map(offer => {
                        if (typeof offer.products === 'string') {
                            const products = offer.products.split(';').map(productStr => {
                                const parts = productStr.split(':');
                                return {
                                    productId: parseInt(parts[0]),
                                    quantity: parseInt(parts[1]),
                                    unitPrice: parseFloat(parts[2])
                                };
                            });
                            offer.products = products;
                        }
                        return offer;
                    });
                }
                
                return data;
            } catch (error) {
                console.error('Error parsing XLSX:', error);
                return null;
            }
        }



    // Import data
    function importData() {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Por favor, selecione um arquivo para importar.');
        return;
    }
    
    const reader = new FileReader();
    
    reader.onload = async function(e) {
        try {
            let importedData;
            
            switch(importFormat) {
                case 'csv':
                    if (file.name.endsWith('.zip')) {
                        importedData = await parseCSVZipImport(e.target.result);
                    } else {
                        // For single CSV, use the existing data structure
                        importedData = getData();
                    }
                    break;
                case 'xlsx':
                    importedData = parseXLSXImport(e.target.result);
                    break;
                case 'json':
                    importedData = JSON.parse(e.target.result);
                    break;
            }
            
            if (importedData && validateImportedData(importedData)) {
                saveData(importedData);
                alert('Dados importados com sucesso!');
                document.getElementById('import-area').style.display = 'none';
                fileInput.value = '';
                
                // Refresh all displays
                initApp();
            } else {
                alert('Erro ao processar os dados importados. Estrutura de dados inv√°lida.');
            }
        } catch (error) {
            console.error('Import error:', error);
            alert('Erro ao importar dados. O arquivo pode estar corrompido ou em formato inv√°lido. Detalhes: ' + error.message);
        }
    };
    
    // Read the file based on format
    switch(importFormat) {
        case 'csv':
            if (file.name.endsWith('.zip')) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
            break;
        case 'xlsx':
            reader.readAsArrayBuffer(file);
            break;
        case 'json':
            reader.readAsText(file);
            break;
    }
}

    // Clear all data
    function clearAllData() {
        if (confirm('Tem certeza que deseja limpar todos os dados? Esta a√ß√£o n√£o pode ser desfeita.')) {
            localStorage.removeItem('crmData');
            alert('Todos os dados foram removidos. A p√°gina ser√° recarregada.');
            location.reload();
        }
    }

    // Update KPI statistics
    function updateKPIStats() {
        const data = getData();
        const offers = data.offers;
        
        // Calculate KPIs
        const totalOffers = offers.length;
        const wonOffers = offers.filter(o => o.status === 'won').length;
        const conversionRate = totalOffers > 0 ? ((wonOffers / totalOffers) * 100).toFixed(1) : 0;
        const totalRevised = offers.reduce((sum, offer) => sum + (offer.revisedQuotes || 0), 0);
        const avgVisits = offers.length > 0 ? (offers.reduce((sum, offer) => sum + (offer.visits || 0), 0) / offers.length).toFixed(1) : 0;
        
        // Update KPI cards
        document.getElementById('kpi-conversion').textContent = `${conversionRate}%`;
        document.getElementById('kpi-revised').textContent = totalRevised;
        document.getElementById('kpi-visits').textContent = avgVisits;
        document.getElementById('kpi-main-loss').textContent = 'Pre√ßo'; // Simplified for demo
    }

    // Generate report
    function generateReport() {
        const reportType = document.getElementById('report-type').value;
        const startDate = document.getElementById('report-start').value;
        const endDate = document.getElementById('report-end').value;
        
        const data = getData();
        let reportContent = '';
        
        switch(reportType) {
            case 'sales':
                reportContent = '<h3>Vendas por Vendedor</h3><ul>';
                data.salespeople.forEach(salesperson => {
                    const sales = data.offers.filter(o => o.salespersonId === salesperson.id && o.status === 'won');
                    const total = sales.reduce((sum, offer) => sum + calculateTotalValue(offer.products), 0);
                    reportContent += `<li>${salesperson.name}: ${formatCurrency(total)}</li>`;
                });
                reportContent += '</ul>';
                break;
                
            case 'segment':
                reportContent = '<h3>Vendas por Segmento</h3><ul>';
                const segments = {};
                data.offers.forEach(offer => {
                    if (offer.status === 'won') {
                        if (!segments[offer.market]) segments[offer.market] = 0;
                        segments[offer.market] += calculateTotalValue(offer.products);
                    }
                });
                for (const segment in segments) {
                    reportContent += `<li>${segment}: ${formatCurrency(segments[segment])}</li>`;
                }
                reportContent += '</ul>';
                break;
                
            case 'status':
                reportContent = '<h3>Ofertas por Status</h3><ul>';
                const statusCounts = {};
                data.offers.forEach(offer => {
                    const statusText = getStatusInfo(offer.status).text;
                    if (!statusCounts[statusText]) statusCounts[statusText] = 0;
                    statusCounts[statusText]++;
                });
                for (const status in statusCounts) {
                    reportContent += `<li>${status}: ${statusCounts[status]}</li>`;
                }
                reportContent += '</ul>';
                break;
        }
        
        document.getElementById('report-results').innerHTML = reportContent;
    }

    // Switch between main tabs
    function switchTab(tabName) {
        // Update navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // Update page title
        const pageTitle = document.getElementById('page-title');
        switch(tabName) {
            case 'dashboard':
                pageTitle.textContent = 'Dashboard';
                break;
            case 'customers':
                pageTitle.textContent = 'Gest√£o de Clientes';
                break;
            case 'offers':
                pageTitle.textContent = 'Todas as Ofertas';
                break;
            case 'funnel':
                pageTitle.textContent = 'Funil de Vendas';
                break;
            case 'kpis':
                pageTitle.textContent = 'Indicadores de Performance';
                break;
            case 'reports':
                pageTitle.textContent = 'Relat√≥rios';
                break;
            case 'management':
                pageTitle.textContent = 'Configura√ß√µes';
                break;
        }
        
        // Show/hide tab content
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');
        
        // Refresh funnel when switching to funnel tab
        if (tabName === 'funnel') {
            initializeEnhancedFunnel();
        }
    }

    // Switch between management tabs
    function switchManagementTab(tabName) {
        // Update navigation
        document.querySelectorAll('[data-management-tab]').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-management-tab="${tabName}"]`).classList.add('active');
        
        // Show/hide tab content
        document.querySelectorAll('.management-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById(`${tabName}-management`).classList.add('active');
    }



// Open product modal for creating or editing
function openProductModal(productId = null) {
    const modal = document.getElementById('product-modal');
    const title = document.getElementById('product-modal-title');
    const form = document.getElementById('product-form');
    const data = getData();
    
    // Reset form
    form.reset();
    
    if (productId) {
        // Edit existing product
        title.textContent = 'Editar Produto';
        const product = data.products.find(p => p.id === productId);
        
        if (product) {
            document.getElementById('product-code').value = product.code;
            document.getElementById('product-description').value = product.description;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-notes').value = product.notes || '';
        }
        
        // Store product ID for update
        form.setAttribute('data-product-id', productId);
    } else {
        // Create new product
        title.textContent = 'Novo Produto';
        form.removeAttribute('data-product-id');
    }
    
    modal.style.display = 'flex';
}

// Save product (create or update)
function saveProduct() {
    const form = document.getElementById('product-form');
    const data = getData();
    
    // Get form values
    const code = document.getElementById('product-code').value;
    const description = document.getElementById('product-description').value;
    const price = parseFloat(document.getElementById('product-price').value);
    const category = document.getElementById('product-category').value;
    const notes = document.getElementById('product-notes').value;
    
    // Validate required fields
    if (!code || !description || !price || !category) {
        alert('Por favor, preencha todos os campos obrigat√≥rios.');
        return;
    }
    
    const productId = form.getAttribute('data-product-id');
    
    if (productId) {
        // Update existing product
        const productIndex = data.products.findIndex(p => p.id === parseInt(productId));
        if (productIndex !== -1) {
            data.products[productIndex] = {
                ...data.products[productIndex],
                code,
                description,
                price,
                category,
                notes
            };
        }
    } else {
        // Create new product
        const newId = data.products.length > 0 ? Math.max(...data.products.map(p => p.id)) + 1 : 1;
        
        data.products.push({
            id: newId,
            code,
            description,
            price,
            category,
            notes
        });
    }
    
    saveData(data);
    document.getElementById('product-modal').style.display = 'none';
    renderProductsTable();
    
    // Also update product dropdowns in offer forms
    updateProductDropdowns();
}

// Delete product
function deleteProduct(productId) {
    if (confirm('Tem certeza que deseja excluir este produto?')) {
        const data = getData();
        
        // Check if product is used in any offers
        const isUsedInOffers = data.offers.some(offer => 
            offer.products.some(product => product.productId === productId)
        );
        
        if (isUsedInOffers) {
            alert('N√£o √© poss√≠vel excluir este produto porque est√° sendo usado em ofertas existentes.');
            return;
        }
        
        // Remove product
        data.products = data.products.filter(p => p.id !== productId);
        saveData(data);
        renderProductsTable();
        updateProductDropdowns();
        
        alert('Produto exclu√≠do com sucesso!');
    }
}

// Render products table
function renderProductsTable() {
    const data = getData();
    const tbody = document.getElementById('products-tbody');
    tbody.innerHTML = '';
    
    data.products.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${product.code}</td>
            <td>${product.description}</td>
            <td>${formatCurrency(product.price)}</td>
            <td>${product.category}</td>
            <td class="action-buttons">
                <button class="action-btn edit-product" data-id="${product.id}">Editar</button>
                <button class="action-btn delete-product" data-id="${product.id}">Excluir</button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Add event listeners
    document.querySelectorAll('.edit-product').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-id'));
            openProductModal(productId);
        });
    });
    
    document.querySelectorAll('.delete-product').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-id'));
            deleteProduct(productId);
        });
    });
}


function updateProductDropdowns() {
    const data = getData();
    const productSelects = document.querySelectorAll('.product-select');
    
    productSelects.forEach(select => {
        const currentValue = select.value;
        
        select.innerHTML = '<option value="">Selecione um produto</option>';
        data.products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.code} - ${product.description} - ${formatCurrency(product.price)}`;
            select.appendChild(option);
        });
        
        // Restore previous selection if it still exists
        if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
            select.value = currentValue;
        }
    });
}


  
// Add this function to create a new product modal
function openNewProductModal() {
    const modal = document.getElementById('product-modal');
    const title = document.getElementById('product-modal-title');
    const form = document.getElementById('product-form');
    const data = getData();
    
    // Reset form
    form.reset();
    
    if (productId) {
        // Edit existing product
        title.textContent = 'Editar Produto';
        const product = data.products.find(p => p.id === productId);
        
        if (product) {
            document.getElementById('product-code').value = product.code;
            document.getElementById('product-description').value = product.description;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-notes').value = product.notes || '';
        }
        
        // Store product ID for update
        form.setAttribute('data-product-id', productId);
    } else {
        // Create new product
        title.textContent = 'Novo Produto';
        form.removeAttribute('data-product-id');
    }
    
    modal.style.display = 'flex';
}

    function setupEventListeners() {
        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                openTab(tab);
            });
        });
        
        // New offer button
        document.getElementById('new-offer-btn').addEventListener('click', function() {
            openNewOfferModal();
        });
        
        // Filter buttons
        document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active button
                document.querySelectorAll('.filter-btn[data-filter]').forEach(b => {
                    b.classList.remove('active');
                });
                this.classList.add('active');
                
                // Apply filter
                const filter = this.getAttribute('data-filter');
                renderOffersTable(filter);
            });
        });
        
        // Show lost offers toggle
        document.getElementById('show-lost-offers').addEventListener('change', function() {
            renderOffersTable();
        });
        
        // Status change in offer form
        document.getElementById('offer-status').addEventListener('change', function() {
            toggleLossReasonField(this.value);
        });
        
        // Modal close buttons
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });
        
        // Cancel offer button
        document.getElementById('cancel-offer').addEventListener('click', function() {
            document.getElementById('offer-modal').style.display = 'none';
        });
        
        // Add product button
        document.getElementById('add-product').addEventListener('click', function() {
            addProductRow();
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

            window.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });
    }

    function openTab(tabName) {
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active class from all nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        
        // Show the selected tab
        document.getElementById(tabName).classList.add('active');
        
        // Add active class to the clicked nav link
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // Update page title
        document.getElementById('page-title').textContent = 
            document.querySelector(`[data-tab="${tabName}"]`).textContent.trim();
        
        // Refresh data if needed
        if (tabName === 'dashboard') {
            renderOffersTable();
            updateDashboardStats();
        } else if (tabName === 'funnel') {
            initializeEnhancedFunnel();
        }
    }

    // Open new offer modal
    function openNewOfferModal() {
        document.getElementById('offer-modal-title').textContent = 'Nova Oferta';
        document.getElementById('offer-form').reset();
        
        // Reset products
        const productsContainer = document.getElementById('offer-products');
        productsContainer.innerHTML = '';
        addProductRow();
        
        // Reset attachment
        document.getElementById('attachment-display').innerHTML = '';
        document.getElementById('offer-attachment').value = '';
        
        // Hide loss reason by default
        document.getElementById('loss-reason-group').style.display = 'none';
        
        // Remove any data-offer-id attribute
        document.getElementById('offer-form').removeAttribute('data-offer-id');
        
        // Show modal
        document.getElementById('offer-modal').style.display = 'block';
    }

    // Save new offer
    function saveNewOffer() {
        const data = getData();
        
        // Get form values
        const customerId = parseInt(document.getElementById('offer-customer').value);
        const salespersonId = parseInt(document.getElementById('offer-salesperson').value);
        const date = document.getElementById('offer-date').value;
        const reminderDate = document.getElementById('offer-reminder').value;
        const closingDate = document.getElementById('offer-closing-date').value; // NEW FIELD
        const status = document.getElementById('offer-status').value;
        const lossReason = document.getElementById('offer-loss-reason').value; // NEW FIELD
        const chance = parseInt(document.getElementById('offer-chance').value);
        const market = document.getElementById('offer-market').value;
        const comments = document.getElementById('offer-comments').value;
        
        // Get products
        const products = [];
        document.querySelectorAll('.product-row').forEach(row => {
            const productId = parseInt(row.querySelector('.product-select').value);
            const quantity = parseInt(row.querySelector('.product-quantity').value);
            const unitPrice = parseFloat(row.querySelector('.product-price').value);
            
            if (productId && quantity && unitPrice) {
                products.push({
                    productId: productId,
                    quantity: quantity,
                    unitPrice: unitPrice
                });
            }
            renderAllOffersTable();
        });
        
        // Handle file attachment
        const fileInput = document.getElementById('offer-attachment');
        let attachment = null;
        
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            attachment = {
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: file.lastModified,
                // In a real app, you would upload the file to a server or storage
                // For this demo, we'll just store the file info
            };
        }
        
        // Create new offer
        const newOffer = {
            id: data.offers.length > 0 ? Math.max(...data.offers.map(o => o.id)) + 1 : 1,
            customerId: customerId,
            salespersonId: salespersonId,
            date: date,
            reminderDate: reminderDate,
            closingDate: closingDate, // NEW FIELD
            status: status,
            lossReason: lossReason, // NEW FIELD
            chance: chance,
            market: market,
            products: products,
            comments: comments,
            attachment: attachment,
            visits: 0,
            revisedQuotes: 0,
            heatmap: calculateHeatmap({
                closingDate: closingDate,
                chance: chance,
                visits: 0,
                revisedQuotes: 0
            }),
            funnelStage: 'stage-qualification'
        };
        
        data.offers.push(newOffer);
        saveData(data);
        
        // Close modal and refresh
        document.getElementById('offer-modal').style.display = 'none';
        renderOffersTable();
        updateDashboardStats();
        initializeEnhancedFunnel();
        
        alert('Oferta criada com sucesso!');
    }

    // Add product row to offer form
    function addProductRow(productId = '', quantity = '', unitPrice = '') {
        const productsContainer = document.getElementById('offer-products');
        const data = getData();
        
        const productRow = document.createElement('div');
        productRow.className = 'product-row form-row';
        
        productRow.innerHTML = `
            <div class="form-col">
                <select class="form-control product-select">
                    <option value="">Selecione um produto</option>
                    ${data.products.map(p => 
                        `<option value="${p.id}" ${p.id === productId ? 'selected' : ''}>${p.code} - ${p.description}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="form-col">
                <input type="number" class="form-control product-quantity" placeholder="Quantidade" min="1" value="${quantity}">
            </div>
            <div class="form-col">
                <input type="number" class="form-control product-price" placeholder="Pre√ßo Unit√°rio" step="0.01" min="0" value="${unitPrice}">
            </div>
            <div class="form-col">
                <button type="button" class="btn btn-danger remove-product">Remover</button>
            </div>
        `;
        
        productsContainer.appendChild(productRow);
        
        // Add event listener to remove button
        productRow.querySelector('.remove-product').addEventListener('click', function() {
            productRow.remove();
        });
    }

    // Populate dropdowns with data
    function populateDropdowns() {
        const data = getData();
        
        // Customers dropdown
        const customerSelect = document.getElementById('offer-customer');
        customerSelect.innerHTML = '<option value="">Selecione um cliente</option>';
        data.customers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.id;
            option.textContent = `${customer.company} - ${customer.name}`;
            customerSelect.appendChild(option);
        });
        
        // Salespeople dropdown
        const salespersonSelect = document.getElementById('offer-salesperson');
        salespersonSelect.innerHTML = '<option value="">Selecione um vendedor</option>';
        data.salespeople.forEach(salesperson => {
            const option = document.createElement('option');
            option.value = salesperson.id;
            option.textContent = salesperson.name;
            salespersonSelect.appendChild(option);
        });
    }

    // Open user modal for creating or editing
// Open user modal for creating or editing
function openUserModal(userId = null) {
    const modal = document.getElementById('user-modal');
    const title = document.getElementById('user-modal-title');
    const form = document.getElementById('user-form');
    const data = getData();
    
    // Reset form
    form.reset();
    
    if (userId) {
        // Edit existing user
        title.textContent = 'Editar Utilizador';
        const user = data.users.find(u => u.id === userId);
        
        if (user) {
            document.getElementById('user-name').value = user.name;
            document.getElementById('user-email').value = user.email;
            document.getElementById('user-role').value = user.role;
            document.getElementById('user-phone').value = user.phone || '';
            document.getElementById('user-department').value = user.department || '';
            document.getElementById('user-notes').value = user.notes || '';
            document.getElementById('user-active').checked = user.active !== false;
            
            // For editing, make password optional
            document.getElementById('user-password').required = false;
            document.getElementById('user-password').placeholder = 'Deixe em branco para manter a senha atual';
        }
        
        // Store user ID for update
        form.setAttribute('data-user-id', userId);
    } else {
        // Create new user
        title.textContent = 'Novo Utilizador';
        form.removeAttribute('data-user-id');
        
        // For new users, password is required
        document.getElementById('user-password').required = true;
        document.getElementById('user-password').placeholder = '';
    }
    
    modal.style.display = 'flex';
}

// Save user (create or update)
function saveUser() {
    const form = document.getElementById('user-form');
    const data = getData();
    
    // Get form values
    const name = document.getElementById('user-name').value;
    const email = document.getElementById('user-email').value;
    const role = document.getElementById('user-role').value;
    const password = document.getElementById('user-password').value;
    const phone = document.getElementById('user-phone').value;
    const department = document.getElementById('user-department').value;
    const notes = document.getElementById('user-notes').value;
    const active = document.getElementById('user-active').checked;
    
    // Validate required fields
    if (!name || !email || !role) {
        alert('Por favor, preencha todos os campos obrigat√≥rios.');
        return;
    }
    
    // For new users, validate password
    const userId = form.getAttribute('data-user-id');
    if (!userId && !password) {
        alert('Por favor, defina uma senha para o novo utilizador.');
        return;
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('Por favor, insira um email v√°lido.');
        return;
    }
    
    // Check if email already exists (for new users or when changing email)
    const existingUser = data.users.find(u => u.email === email && u.id !== parseInt(userId || 0));
    if (existingUser) {
        alert('J√° existe um utilizador com este email.');
        return;
    }
    
    if (userId) {
        // Update existing user
        const userIndex = data.users.findIndex(u => u.id === parseInt(userId));
        if (userIndex !== -1) {
            const updatedUser = {
                ...data.users[userIndex],
                name,
                email,
                role,
                phone,
                department,
                notes,
                active
            };
            
            // Only update password if provided
            if (password) {
                updatedUser.password = password; // In a real app, you'd hash this
            }
            
            data.users[userIndex] = updatedUser;
        }
    } else {
        // Create new user
        const newId = data.users.length > 0 ? Math.max(...data.users.map(u => u.id)) + 1 : 1;
        
        data.users.push({
            id: newId,
            name,
            email,
            role,
            password: password, // In a real app, you'd hash this
            phone,
            department,
            notes,
            active: active !== false,
            createdAt: new Date().toISOString().split('T')[0]
        });
        
        // Also add to salespeople if role is Vendedor
        if (role === 'Vendedor') {
            const salespersonExists = data.salespeople.some(s => s.name === name);
            if (!salespersonExists) {
                const newSalespersonId = data.salespeople.length > 0 ? Math.max(...data.salespeople.map(s => s.id)) + 1 : 1;
                data.salespeople.push({
                    id: newSalespersonId,
                    name: name
                });
            }
        }
    }
    
    saveData(data);
    document.getElementById('user-modal').style.display = 'none';
    renderUsersTable();
    updateSalespeopleDropdown();
    
    alert(`Utilizador ${userId ? 'atualizado' : 'criado'} com sucesso!`);
}

// Delete user
function deleteUser(userId) {
    if (confirm('Tem certeza que deseja excluir este utilizador?')) {
        const data = getData();
        
        // Prevent deleting the last admin
        const adminUsers = data.users.filter(u => u.role === 'Administrador' && u.active);
        const userToDelete = data.users.find(u => u.id === userId);
        
        if (userToDelete && userToDelete.role === 'Administrador' && adminUsers.length <= 1) {
            alert('N√£o √© poss√≠vel excluir o √∫nico administrador ativo do sistema.');
            return;
        }
        
        // Check if user has associated offers
        const hasOffers = data.offers.some(offer => offer.salespersonId === userId);
        if (hasOffers) {
            alert('N√£o √© poss√≠vel excluir este utilizador porque existem ofertas associadas a ele. Voc√™ pode desativar o utilizador em vez de exclu√≠-lo.');
            return;
        }
        
        // Remove user
        data.users = data.users.filter(u => u.id !== userId);
        saveData(data);
        renderUsersTable();
        
        alert('Utilizador exclu√≠do com sucesso!');
    }
}

// Toggle user active status
function toggleUserStatus(userId) {
    const data = getData();
    const userIndex = data.users.findIndex(u => u.id === userId);
    
    if (userIndex !== -1) {
        const user = data.users[userIndex];
        
        // Prevent deactivating the last admin
        if (user.role === 'Administrador' && user.active) {
            const activeAdmins = data.users.filter(u => u.role === 'Administrador' && u.active && u.id !== userId);
            if (activeAdmins.length === 0) {
                alert('N√£o √© poss√≠vel desativar o √∫nico administrador ativo do sistema.');
                return;
            }
        }
        
        data.users[userIndex].active = !data.users[userIndex].active;
        saveData(data);
        renderUsersTable();
        
        alert(`Utilizador ${data.users[userIndex].active ? 'ativado' : 'desativado'} com sucesso!`);
    }
}

// Render users table
function renderUsersTable() {
    const data = getData();
    const tbody = document.getElementById('users-tbody');
    tbody.innerHTML = '';
    
    data.users.forEach(user => {
        const statusClass = user.active ? 'status-badge status-won' : 'status-badge status-lost';
        const statusText = user.active ? 'Ativo' : 'Inativo';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.role}</td>
            <td><span class="${statusClass}">${statusText}</span></td>
            <td class="action-buttons">
                <button class="action-btn edit-user" data-id="${user.id}">Editar</button>
                <button class="action-btn toggle-user" data-id="${user.id}">
                    ${user.active ? 'Desativar' : 'Ativar'}
                </button>
                <button class="action-btn delete-user" data-id="${user.id}">Excluir</button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Add event listeners for user actions
    document.querySelectorAll('.edit-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = parseInt(this.getAttribute('data-id'));
            openUserModal(userId);
        });
    });
    
    document.querySelectorAll('.toggle-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = parseInt(this.getAttribute('data-id'));
            toggleUserStatus(userId);
        });
    });
    
    document.querySelectorAll('.delete-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = parseInt(this.getAttribute('data-id'));
            deleteUser(userId);
        });
    });
}

// Update salespeople dropdown when users change
function updateSalespeopleDropdown() {
    const data = getData();
    const salespersonSelect = document.getElementById('offer-salesperson');
    
    if (salespersonSelect) {
        const currentValue = salespersonSelect.value;
        
        salespersonSelect.innerHTML = '<option value="">Selecione um vendedor</option>';
        data.salespeople.forEach(salesperson => {
            const option = document.createElement('option');
            option.value = salesperson.id;
            option.textContent = salesperson.name;
            salespersonSelect.appendChild(option);
        });
        
        // Restore previous selection if it still exists
        if (currentValue && salespersonSelect.querySelector(`option[value="${currentValue}"]`)) {
            salespersonSelect.value = currentValue;
        }
    }
}


// Toggle user active status
function toggleUserStatus(userId) {
    const data = getData();
    const userIndex = data.users.findIndex(u => u.id === userId);
    
    if (userIndex !== -1) {
        data.users[userIndex].active = !data.users[userIndex].active;
        saveData(data);
        renderUsersTable();
        alert(`Usu√°rio ${data.users[userIndex].active ? 'ativado' : 'desativado'} com sucesso!`);
    }
}

// Toggle password visibility
function setupPasswordToggle() {
    const passwordField = document.getElementById('user-password');
    if (passwordField) {
        // Create toggle button
        const toggleBtn = document.createElement('button');
        toggleBtn.type = 'button';
        toggleBtn.className = 'toggle-password';
        toggleBtn.innerHTML = 'üëÅÔ∏è';
        toggleBtn.title = 'Mostrar/ocultar senha';
        
        // Insert after password field
        passwordField.parentNode.appendChild(toggleBtn);
        
        toggleBtn.addEventListener('click', function() {
            const type = passwordField.type === 'password' ? 'text' : 'password';
            passwordField.type = type;
            toggleBtn.innerHTML = type === 'password' ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è';
        });
    }
}




      // Initialize the application
   function initApp() {
    // Initialize data
    initializeData();
    setupEventListeners();
    setupTableSorting();
    
    // Set up event listeners for navigation
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function() {
            const tab = this.getAttribute('data-tab');
            switchTab(tab);
        });
    });
    
    // Set up event listeners for management tabs
    document.querySelectorAll('[data-management-tab]').forEach(tab => {
        tab.addEventListener('click', function() {
            const managementTab = this.getAttribute('data-management-tab');
            switchManagementTab(managementTab);
        });
    });
    
    // Set up event listeners for filter buttons
    document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', function() {
            const filter = this.getAttribute('data-filter');
            
            // Update active state
            document.querySelectorAll('[data-filter]').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            renderOffersTable(filter);
        });
    });
    
    // Set up event listeners for modal close buttons
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
        });
    });
    
    // Set up event listener for new offer buttons
    document.getElementById('new-offer-btn').addEventListener('click', function() {
        openNewOfferModal();
    });
    
    document.getElementById('new-offer-btn2').addEventListener('click', function() {
        openNewOfferModal();
    });
    
    // Set up event listener for new customer button
    document.getElementById('new-customer-btn').addEventListener('click', function() {
        openCustomerModal();
    });
    
    // NEW: Set up event listeners for management section buttons
    document.getElementById('new-user-btn')?.addEventListener('click', function() {
    openUserModal();
});
    
    document.getElementById('new-product-btn')?.addEventListener('click', function() {
        openProductModal();
    });

    document.getElementById('product-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveProduct();
    });

    document.getElementById('cancel-product')?.addEventListener('click', function() {
        document.getElementById('product-modal').style.display = 'none';
    });
    
    // Set up event listener for add product button
    document.getElementById('add-product').addEventListener('click', function() {
        addProductRow();
    });

document.getElementById('user-form').addEventListener('submit', function(e) {
    e.preventDefault();
    saveUser();
});

document.getElementById('cancel-user')?.addEventListener('click', function() {
    document.getElementById('user-modal').style.display = 'none';
});
    
    // Set up event listener for offer form submission
    const offerForm = document.getElementById('offer-form');
    offerForm.onsubmit = function(e) {
        e.preventDefault();
        const offerId = offerForm.getAttribute('data-offer-id');
        if (offerId) {
            updateOffer(parseInt(offerId));
        } else {
            saveNewOffer();
        }
    };
    
    // Set up event listener for customer form submission
    document.getElementById('customer-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveCustomer();
    });
    
    // Set up event listener for email form submission
    document.getElementById('email-reminder-form').addEventListener('submit', function(e) {
        e.preventDefault();
        // The actual handler is set in openEmailReminderModal
    });
    
    // Set up event listener for cancel buttons
    document.getElementById('cancel-offer').addEventListener('click', function() {
        document.getElementById('offer-modal').style.display = 'none';
    });
    
    document.getElementById('cancel-customer').addEventListener('click', function() {
        document.getElementById('customer-modal').style.display = 'none';
    });
    
    document.getElementById('cancel-email').addEventListener('click', function() {
        document.getElementById('email-reminder-modal').style.display = 'none';
    });
    
    // Set up event listener for data management buttons
    document.getElementById('export-all').addEventListener('click', function() {
        exportAllData();
    });
    
    document.getElementById('import-data').addEventListener('click', function() {
        document.getElementById('import-area').style.display = 'block';
    });
    
    document.getElementById('confirm-import').addEventListener('click', function() {
        importData();
    });
    
    document.getElementById('clear-data').addEventListener('click', function() {
        clearAllData();
    });
    
    // Set up KPI filter button
    document.getElementById('apply-kpi-filter').addEventListener('click', function() {
        updateKPIStats();
    });
    
    // Set up report buttons
    document.getElementById('generate-report').addEventListener('click', function() {
        generateReport();
    });
    
    // Initialize the dashboard
    updateDashboardStats();
    renderOffersTable();
    renderCustomersTable();
    renderAllOffersTable();
    renderSalesFunnel();
    updateKPIStats();
    renderProductsTable();
    // Populate dropdowns
    populateDropdowns();
    renderUsersTable();
    setupFormatSelection();

  
setupPasswordToggle();
}
    // Initialize the application when the DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>

      
